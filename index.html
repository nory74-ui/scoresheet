<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Basketball Score Sheet (Mobile Offline)</title>
<style>
    /* --- Base Styles --- */
    :root {
        --bg-color: #f3f4f6;
        --text-color: #111827;
        --primary-color: #1e3a8a; /* Blue 900 */
        --primary-light: #3b82f6; /* Blue 500 */
        --accent-color: #fbbf24; /* Amber 400 */
        --danger-color: #ef4444; /* Red 500 */
        --success-color: #10b981; /* Emerald 500 */
        --border-color: #d1d5db;
        --white: #ffffff;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        background-color: var(--bg-color);
        color: var(--text-color);
        height: 100vh; /* Fallback */
        height: 100dvh; /* Dynamic viewport height for mobile */
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    button { cursor: pointer; border: none; font-family: inherit; outline: none; }
    button:active { transform: scale(0.98); }
    input, select { border: 1px solid var(--border-color); border-radius: 4px; padding: 0.5rem; width: 100%; font-size: 16px; /* Prevent zoom on iPhone */ }

    /* --- Utility Classes --- */
    .hidden { display: none !important; }
    .flex { display: flex; }
    .flex-col { flex-direction: column; }
    .items-center { align-items: center; }
    .justify-between { justify-content: space-between; }
    .justify-center { justify-content: center; }
    .justify-end { justify-content: flex-end; }
    .gap-1 { gap: 0.25rem; }
    .gap-2 { gap: 0.5rem; }
    .gap-4 { gap: 1rem; }
    .p-1 { padding: 0.25rem; }
    .p-2 { padding: 0.5rem; }
    .p-4 { padding: 1rem; }
    .px-2 { padding-left: 0.5rem; padding-right: 0.5rem; }
    .px-4 { padding-left: 1rem; padding-right: 1rem; }
    .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
    .m-1 { margin: 0.25rem; }
    .mt-1 { margin-top: 0.25rem; }
    .mt-2 { margin-top: 0.5rem; }
    .mb-2 { margin-bottom: 0.5rem; }
    .w-full { width: 100%; }
    .h-full { height: 100%; }
    .text-center { text-align: center; }
    .text-right { text-align: right; }
    .text-left { text-align: left; }
    .font-bold { font-weight: bold; }
    .text-sm { font-size: 0.875rem; }
    .text-xs { font-size: 0.75rem; }
    .text-lg { font-size: 1.125rem; }
    .text-xl { font-size: 1.25rem; }
    .text-white { color: white; }
    .text-red { color: var(--danger-color); }
    .text-gray-300 { color: #d1d5db; }
    .text-gray-400 { color: #9ca3af; }
    .text-gray-500 { color: #6b7280; }
    .bg-white { background-color: var(--white); }
    .bg-gray-100 { background-color: #f3f4f6; }
    .bg-gray-700 { background-color: #374151; }
    .border { border: 1px solid var(--border-color); }
    .border-b { border-bottom: 1px solid var(--border-color); }
    .border-t { border-top: 1px solid var(--border-color); }
    .border-r { border-right: 1px solid var(--border-color); }
    .border-l { border-left: 1px solid var(--border-color); }
    .border-black { border-color: black; }
    .rounded { border-radius: 0.375rem; }
    .rounded-full { border-radius: 9999px; }
    .shadow { box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); }
    .grid { display: grid; }
    .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    .overflow-auto { overflow: auto; }
    .relative { position: relative; }
    .absolute { position: absolute; }
    .top-0 { top: 0; }
    .top-1 { top: 0.25rem; }
    .left-1 { left: 0.25rem; }
    .bottom-0 { bottom: 0; }
    .z-10 { z-index: 10; }

    /* --- Responsive Layout Styles --- */
    
    /* Navigation */
    nav {
        background-color: var(--primary-color);
        color: white;
        padding: 0.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        z-index: 20;
        flex-shrink: 0;
    }
    
    .nav-title-area { display: flex; align-items: center; gap: 0.5rem; }
    .nav-title { font-weight: bold; font-size: 1.125rem; white-space: nowrap; }
    
    .nav-menu { display: flex; gap: 0.25rem; background-color: rgba(255,255,255,0.1); padding: 0.25rem; border-radius: 0.375rem; overflow-x: auto; }
    .nav-btn {
        background: none; color: #bfdbfe; padding: 0.5rem 0.75rem; border-radius: 0.25rem;
        display: flex; align-items: center; gap: 0.25rem; font-weight: bold; font-size: 0.875rem; white-space: nowrap;
    }
    .nav-btn.active { background-color: white; color: var(--primary-color); box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
    
    /* Input Panel Layout */
    .input-main-layout {
        display: flex;
        height: 100%;
        overflow: hidden;
        flex-direction: row; /* Default: Horizontal split for Desktop/Tablet */
    }
    
    .player-area {
        flex: 1;
        overflow-y: auto;
        background-color: white;
        border-right: 1px solid var(--border-color);
        padding: 0.5rem;
        padding-bottom: 5rem; /* Space for scrolling */
    }
    
    .controls-area {
        width: 350px; /* Fixed width for controls on desktop */
        background-color: #f3f4f6;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        justify-content: center;
        gap: 1rem;
        border-left: 1px solid var(--border-color);
        flex-shrink: 0;
    }

    /* Score Header */
    .score-header {
        background-color: #111827; color: white; padding: 0.5rem;
        display: flex; justify-content: space-between; align-items: center;
        flex-shrink: 0;
    }
    .team-card {
        flex: 1; padding: 0.5rem; border-radius: 0.5rem; text-align: center; cursor: pointer;
        border: 2px solid transparent; transition: background-color 0.2s;
        max-width: 45%;
    }
    .team-card.selected { background-color: #374151; border-color: #60a5fa; }
    .score-display { font-size: 2rem; font-weight: bold; color: #facc15; font-family: monospace; line-height: 1; }
    
    /* Player Grid */
    .player-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
        gap: 0.5rem;
    }
    .player-btn {
        background-color: white; border: 1px solid var(--border-color); color: #1f2937;
        padding: 0.5rem; border-radius: 0.5rem; display: flex; flex-direction: column; align-items: center; justify-content: center;
        height: 80px; position: relative; transition: all 0.1s;
    }
    .player-btn.selected { background-color: var(--primary-light); color: white; border-color: var(--primary-light); box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    .player-btn.disabled { opacity: 0.5; background-color: #fef2f2; border-color: #fecaca; }

    /* Control Buttons */
    .control-btn {
        color: white; padding: 1rem; border-radius: 0.5rem; font-weight: bold; box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        font-size: 1rem;
    }
    .control-btn:active { transform: scale(0.96); }
    .control-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    
    .btn-green { background-color: var(--success-color); }
    .btn-yellow { background-color: #eab308; color: white; }
    .btn-gray { background-color: #6b7280; }
    .btn-orange-outline { background-color: #ffedd5; color: #7c2d12; border: 1px solid #fdba74; padding: 0.5rem; }

    /* --- MOBILE RESPONSIVE QUERIES --- */
    @media (max-width: 768px) {
        /* Adjust Nav */
        nav { padding: 0.5rem; }
        .nav-title { display: none; } /* Hide title on small screens */
        .nav-menu { width: 100%; justify-content: space-around; }
        .nav-btn { padding: 0.5rem; flex: 1; justify-content: center; font-size: 0.75rem; flex-direction: column; gap: 0.1rem; }
        .nav-btn svg { width: 1.25rem; height: 1.25rem; }

        /* Stack Input Layout vertically */
        .input-main-layout { flex-direction: column; }
        
        /* Player Area takes remaining space */
        .player-area {
            flex: 1;
            border-right: none;
            border-bottom: 1px solid var(--border-color);
            padding: 0.5rem;
            overflow-y: auto;
        }
        
        /* Controls Area sits at the bottom */
        .controls-area {
            width: 100%;
            height: auto;
            border-left: none;
            border-top: 1px solid var(--border-color);
            padding: 0.5rem;
            gap: 0.5rem;
            background-color: white;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }

        /* Adjust Header */
        .score-header { padding: 0.25rem; }
        .score-display { font-size: 1.75rem; }
        .team-card { padding: 0.25rem; }
        .team-name { font-size: 0.75rem; }
        .stat-text { font-size: 0.7rem; }

        /* Adjust Grid for Mobile */
        .player-grid { grid-template-columns: repeat(4, 1fr); gap: 0.35rem; } /* 4 columns on mobile */
        .player-btn { height: 70px; padding: 0.25rem; }
        .player-btn .text-xl { font-size: 1.125rem; } /* Smaller numbers */
        
        /* Adjust Controls */
        .control-group-score { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem; }
        .control-group-action { display: grid; grid-template-columns: 2fr 1fr; gap: 0.5rem; margin-top: 0.5rem; }
        .control-btn { padding: 0.75rem; font-size: 0.9rem; }
        .control-btn span.sub { font-size: 0.65rem; }
        
        /* Hide selected player text to save space, show in highlight */
        .selected-player-display { font-size: 0.875rem; height: 1.5rem; margin-bottom: 0.25rem; text-align: center; }
    }

    /* Print Specifics (Restored from previous version) */
    .sheet-container {
        background-color: white; width: 210mm; min-height: 297mm; margin: 0 auto; padding: 15mm;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        font-family: "Times New Roman", "YuMincho", "Hiragino Mincho ProN", serif;
        color: black;
    }
    .sheet-table { width: 100%; border-collapse: collapse; font-size: 10px; table-layout: fixed; }
    .sheet-table th, .sheet-table td { border: 1px solid black; padding: 2px; }
    .sheet-table th { background-color: #f3f4f6; text-align: center; text-transform: uppercase; }
    .text-red-print { color: red; }
    
    .running-score-grid { display: flex; width: 100%; border: 2px solid black; }
    .running-col { width: 25%; border-right: 1px solid black; display: flex; flex-direction: column; }
    .running-col:last-child { border-right: none; }
    .running-row { display: flex; height: 15px; border-bottom: 1px solid #d1d5db; align-items: center; font-size: 10px; }
    .running-cell { flex: 1; text-align: center; height: 100%; display: flex; align-items: center; justify-content: center; }
    .running-cell.num { font-weight: bold; width: 25%; flex: none; }
    .running-cell.score { width: 25%; flex: none; }
    
    @media print {
        @page { size: A4 portrait; margin: 0; }
        body { background-color: white; height: auto; display: block; overflow: visible; }
        nav, #panel-input, #panel-settings, #panel-history, #notification { display: none !important; }
        #panel-sheet { display: block !important; padding: 0 !important; margin: 0 !important; width: 100% !important; height: 100% !important; }
        .sheet-container { box-shadow: none; margin: 0; padding: 10mm; width: 100%; min-height: 100vh; }
        .print-hidden { display: none !important; }
        * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
    }

    /* Icons */
    .icon { width: 1.25rem; height: 1.25rem; stroke: currentColor; stroke-width: 2; fill: none; stroke-linecap: round; stroke-linejoin: round; }
    
    /* Notification */
    #notification {
        position: fixed; top: 1rem; left: 50%; transform: translateX(-50%);
        padding: 0.75rem 1.5rem; border-radius: 2rem; color: white; font-weight: bold;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 100;
        animation: fadeOut 3s forwards;
    }
    @keyframes fadeOut { 0% { opacity: 0; top: 0; } 10% { opacity: 1; top: 1rem; } 80% { opacity: 1; } 100% { opacity: 0; display: none; } }
    .toast-success { background-color: var(--success-color); }
    .toast-error { background-color: var(--danger-color); }

</style>
</head>
<body>

<!-- Navigation -->
<nav>
    <div class="nav-title-area">
        <svg class="icon" viewBox="0 0 24 24"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
        <span class="nav-title">Score Sheet</span>
    </div>
    <div class="nav-menu">
        <button class="nav-btn active" onclick="app.setViewMode('input')" id="btn-input">
            <svg class="icon" viewBox="0 0 24 24"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg> 入力
        </button>
        <button class="nav-btn" onclick="app.setViewMode('sheet')" id="btn-sheet">
            <svg class="icon" viewBox="0 0 24 24"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></svg> 公式シート
        </button>
        <button class="nav-btn" onclick="app.setViewMode('settings')" id="btn-settings">
            <svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg> 設定
        </button>
        <button class="nav-btn" onclick="app.setViewMode('history')" id="btn-history">
            <svg class="icon" viewBox="0 0 24 24"><path d="m6 14 1.45-2.9A2 2 0 0 1 9.24 10H20a2 2 0 0 1 1.94 2.5l-1.55 6a2 2 0 0 1-1.94 1.5H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h3.9a2 2 0 0 1 1.69.9l.81 1.2a2 2 0 0 0 1.67.9H18a2 2 0 0 1 2 2v2"/></svg> 保存
        </button>
    </div>
</nav>

<!-- Main App Area -->
<main id="app-container" class="flex-1 bg-gray-100 relative">
    
    <!-- Input Panel -->
    <div id="panel-input" class="h-full flex flex-col">
        <!-- Score Header -->
        <div class="score-header">
            <div id="team-a-card" class="team-card" onclick="app.selectTeam('A')">
                <div class="team-name text-gray-400" id="input-team-a-name">Team A</div>
                <div class="score-display" id="input-score-a">0</div>
                <div class="stat-text mt-1 flex justify-center gap-2 text-xs">
                    <span>F: <span id="input-foul-a">0</span></span>
                    <span>TO: <span id="input-to-a">0</span></span>
                </div>
            </div>
            
            <div class="text-center px-2">
                <div class="text-xl font-bold text-red" id="input-quarter">Q1</div>
                <button onclick="app.nextQuarter()" class="mt-1 bg-gray-700 active:bg-gray-600 text-white text-xs px-2 py-1 rounded">Next Q</button>
            </div>

            <div id="team-b-card" class="team-card" onclick="app.selectTeam('B')">
                <div class="team-name text-gray-400" id="input-team-b-name">Team B</div>
                <div class="score-display" id="input-score-b">0</div>
                <div class="stat-text mt-1 flex justify-center gap-2 text-xs">
                    <span>F: <span id="input-foul-b">0</span></span>
                    <span>TO: <span id="input-to-b">0</span></span>
                </div>
            </div>
        </div>

        <!-- Content Split -->
        <div class="input-main-layout">
            
            <!-- Player List Area -->
            <div class="player-area">
                <div class="mb-2 font-bold text-gray-500 text-sm flex justify-between">
                    <span id="player-list-title">選手選択</span>
                </div>
                <div id="player-grid" class="player-grid">
                    <!-- Players rendered by JS -->
                </div>
            </div>

            <!-- Controls Area (Bottom on Mobile) -->
            <div class="controls-area">
                <div class="selected-player-display">
                    <span class="text-xs text-gray-500">選択中:</span>
                    <span class="font-bold text-lg" id="selected-player-name">未選択</span>
                </div>

                <div class="control-group-score">
                    <button class="control-btn btn-green" onclick="app.addScore(1)">
                        <span>+1</span><span class="sub text-xs font-normal opacity-80">FT</span>
                    </button>
                    <button class="control-btn btn-green" onclick="app.addScore(2)">
                        <span>+2</span><span class="sub text-xs font-normal opacity-80">FG</span>
                    </button>
                    <button class="control-btn btn-green" onclick="app.addScore(3)">
                        <span>+3</span><span class="sub text-xs font-normal opacity-80">3P</span>
                    </button>
                </div>

                <div class="control-group-action">
                    <button class="control-btn btn-yellow" onclick="app.addFoul('P')">P ファウル</button>
                    <button class="control-btn btn-gray" onclick="app.undo()">
                        <div class="flex items-center gap-1 justify-center">
                            <svg class="icon" viewBox="0 0 24 24"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg> 戻る
                        </div>
                    </button>
                </div>

                <div class="grid grid-cols-2 gap-2 pt-2 border-t border-gray-300">
                    <button class="control-btn btn-orange-outline" onclick="app.addTimeout('A')">
                        <div class="flex items-center gap-1 text-xs"><svg class="icon" style="width:14px;height:14px" viewBox="0 0 24 24"><circle cx="12" cy="14" r="8"/><line x1="10" x2="14" y1="2" y2="2"/><line x1="12" x2="15" y1="14" y2="11"/></svg> Team A</div>
                        <span class="text-xs font-normal" id="to-btn-text-a">TO</span>
                    </button>
                    <button class="control-btn btn-orange-outline" onclick="app.addTimeout('B')">
                        <div class="flex items-center gap-1 text-xs"><svg class="icon" style="width:14px;height:14px" viewBox="0 0 24 24"><circle cx="12" cy="14" r="8"/><line x1="10" x2="14" y1="2" y2="2"/><line x1="12" x2="15" y1="14" y2="11"/></svg> Team B</div>
                        <span class="text-xs font-normal" id="to-btn-text-b">TO</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Official Sheet Panel -->
    <div id="panel-sheet" class="hidden overflow-auto p-2 bg-gray-200 h-full">
        <div class="flex justify-end mb-2 print-hidden">
            <button onclick="window.print()" class="bg-yellow-500 text-white px-4 py-2 rounded font-bold shadow flex items-center gap-2">
                <svg class="icon" viewBox="0 0 24 24"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></svg>
                印刷 / PDF
            </button>
        </div>
        <div class="sheet-container" id="sheet-content"></div>
        <div class="print-hidden text-xs text-center text-gray-500 mt-2">Basketball Score Sheet App - Mobile & Print Ready</div>
    </div>

    <!-- Settings Panel -->
    <div id="panel-settings" class="hidden p-4 overflow-auto h-full">
        <div class="max-w-4xl mx-auto bg-white shadow rounded p-4">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h2 class="text-lg font-bold flex items-center gap-2">設定・編集</h2>
                <button onclick="app.setViewMode('input')" class="bg-blue-600 text-white px-3 py-2 rounded flex items-center gap-1 text-sm font-bold">
                     完了
                </button>
            </div>
            
            <div class="flex border-b mb-4 text-sm">
                <button onclick="app.setSettingsTab('Info')" class="flex-1 py-2 font-bold border-b-2 text-center" id="tab-info">Info</button>
                <button onclick="app.setSettingsTab('A')" class="flex-1 py-2 font-bold text-center" id="tab-a">Team A</button>
                <button onclick="app.setSettingsTab('B')" class="flex-1 py-2 font-bold text-center" id="tab-b">Team B</button>
            </div>

            <div id="settings-content"></div>
        </div>
    </div>

    <!-- History Panel -->
    <div id="panel-history" class="hidden p-4 overflow-auto h-full">
        <div class="max-w-4xl mx-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold flex items-center gap-2">保存データ (Local)</h2>
                <button onclick="app.saveGameData()" class="bg-blue-600 text-white px-3 py-2 rounded text-sm font-bold">新規保存</button>
            </div>
            <div id="history-list" class="grid gap-4"></div>
        </div>
    </div>

</main>

<div id="notification" class="hidden"></div>

<script>
/**
 * Basketball Score Sheet App (Mobile Optimized)
 */
class ScoreApp {
    constructor() {
        this.STORAGE_KEY = 'basketball_score_sheet_data_v13';
        this.initialPlayers = (teamName) => Array.from({ length: 18 }, (_, i) => ({
            id: `${teamName}-${i + 1}`,
            number: '', name: "", isCaptain: false, fouls: [], points: 0
        }));

        this.state = {
            viewMode: 'input',
            settingsTab: 'Info',
            selectedTeam: 'A',
            selectedPlayerId: null,
            quarter: 1,
            gameInfo: {
                competition: '令和__年度 大会', date: new Date().toISOString().split('T')[0], time: '10:00', place: '体育館',
                gameNo: '', crewChief: '', umpire1: '', umpire2: '', scorer: '', assistantScorer: '', timer: '', shotClock: '', endTime: ''
            },
            teamA: { name: 'Team A', color: '', coach: '', assistantCoach: '', players: this.initialPlayers('A'), timeouts: { 1: [], 2: [] }, teamFouls: { 1: 0, 2: 0, 3: 0, 4: 0 } },
            teamB: { name: 'Team B', color: '', coach: '', assistantCoach: '', players: this.initialPlayers('B'), timeouts: { 1: [], 2: [] }, teamFouls: { 1: 0, 2: 0, 3: 0, 4: 0 } },
            scores: [], history: []
        };

        this.savedGames = [];
        this.loadSavedGames();
        this.render();
    }

    getHalfKey(quarter) { return quarter <= 2 ? 1 : 2; }
    
    calculateTotalScore(team) {
        return this.state.scores.filter(s => s.team === team).reduce((sum, s) => sum + s.points, 0);
    }

    calculateQuarterScore(team, q) {
        return this.state.scores.filter(s => s.team === team && s.quarter === q).reduce((sum, s) => sum + s.points, 0);
    }

    saveStateForUndo() {
        const currentState = JSON.parse(JSON.stringify(this.state));
        delete currentState.history;
        this.state.history.push(currentState);
        if(this.state.history.length > 20) this.state.history.shift();
    }

    showNotification(type, message) {
        const el = document.getElementById('notification');
        el.className = type === 'success' ? 'toast-success' : 'toast-error';
        el.innerText = message;
        el.style.display = 'block';
        el.style.animation = 'none';
        el.offsetHeight; /* trigger reflow */
        el.style.animation = 'fadeOut 3s forwards';
    }

    setViewMode(mode) {
        this.state.viewMode = mode;
        this.render();
    }

    setSettingsTab(tab) {
        this.state.settingsTab = tab;
        this.renderSettings();
    }

    selectTeam(team) {
        this.state.selectedTeam = team;
        this.state.selectedPlayerId = null;
        this.renderInput();
    }

    selectPlayer(id) {
        const teamKey = this.state.selectedTeam === 'A' ? 'teamA' : 'teamB';
        const player = this.state[teamKey].players.find(p => p.id === id);
        if (player.fouls.length >= 5) return;
        this.state.selectedPlayerId = id;
        this.renderInputControls();
        this.renderPlayerGrid();
    }

    addScore(points) {
        if (!this.state.selectedPlayerId) return alert('選手を選択してください');
        this.saveStateForUndo();
        const teamKey = this.state.selectedTeam === 'A' ? 'teamA' : 'teamB';
        const player = this.state[teamKey].players.find(p => p.id === this.state.selectedPlayerId);
        player.points += points;
        this.state.scores.push({
            quarter: this.state.quarter, team: this.state.selectedTeam, playerNumber: player.number, points: points
        });
        this.renderInput();
    }

    addFoul(type) {
        if (!this.state.selectedPlayerId) return alert('選手を選択してください');
        this.saveStateForUndo();
        const teamKey = this.state.selectedTeam === 'A' ? 'teamA' : 'teamB';
        const player = this.state[teamKey].players.find(p => p.id === this.state.selectedPlayerId);
        if (player.fouls.length < 5) {
            player.fouls.push(type);
            this.state[teamKey].teamFouls[this.state.quarter] = (this.state[teamKey].teamFouls[this.state.quarter] || 0) + 1;
        }
        this.renderInput();
    }

    addTimeout(targetTeam) {
        const teamKey = targetTeam === 'A' ? 'teamA' : 'teamB';
        const half = this.getHalfKey(this.state.quarter);
        const limit = half === 1 ? 2 : 3;
        if (this.state[teamKey].timeouts[half].length >= limit) return alert(`タイムアウト回数制限(${limit}回)に達しています。`);
        this.saveStateForUndo();
        this.state[teamKey].timeouts[half].push("X");
        this.renderInput();
    }

    nextQuarter() {
        this.saveStateForUndo();
        this.state.quarter += 1;
        this.renderInput();
    }

    undo() {
        if (this.state.history.length === 0) return;
        const prev = this.state.history.pop();
        const history = this.state.history;
        this.state = { ...prev, history };
        this.render();
    }

    updateGameInfo(field, value) { this.state.gameInfo[field] = value; }
    updateTeamInfo(t, field, value) { 
        this.state[t==='A'?'teamA':'teamB'][field] = value; 
        if(field==='name') this.renderInput();
    }
    updatePlayer(t, id, field, value) {
        const player = this.state[t==='A'?'teamA':'teamB'].players.find(p => p.id === id);
        if(player) player[field] = value;
    }
    toggleCaptain(t, id) {
        const team = this.state[t==='A'?'teamA':'teamB'];
        team.players.forEach(p => p.isCaptain = (p.id === id ? !p.isCaptain : false));
        this.renderSettings();
    }

    saveGameData() {
        const id = Date.now().toString();
        const data = {
            id, title: `${this.state.teamA.name} vs ${this.state.teamB.name}`,
            gameState: JSON.parse(JSON.stringify(this.state)), createdAt: new Date().toISOString(),
            finalScoreA: this.calculateTotalScore('A'), finalScoreB: this.calculateTotalScore('B'), quarter: this.state.quarter
        };
        data.gameState.history = [];
        this.savedGames = [data, ...this.savedGames];
        localStorage.setItem(this.STORAGE_KEY, JSON.stringify(this.savedGames));
        this.showNotification('success', '保存しました');
        if(this.state.viewMode === 'history') this.renderHistory();
    }

    loadSavedGames() {
        try { this.savedGames = JSON.parse(localStorage.getItem(this.STORAGE_KEY) || '[]'); } catch (e) { console.error(e); }
    }

    loadGame(id) {
        const g = this.savedGames.find(g => g.id === id);
        if (g) {
            this.state = JSON.parse(JSON.stringify(g.gameState));
            this.state.history = [];
            this.state.viewMode = 'input';
            this.render();
            this.showNotification('success', '読み込みました');
        }
    }

    deleteGame(id) {
        if(!confirm('削除しますか？')) return;
        this.savedGames = this.savedGames.filter(g => g.id !== id);
        localStorage.setItem(this.STORAGE_KEY, JSON.stringify(this.savedGames));
        this.renderHistory();
        this.showNotification('success', '削除しました');
    }

    render() {
        ['input', 'sheet', 'settings', 'history'].forEach(mode => {
            const el = document.getElementById(`panel-${mode}`);
            if(this.state.viewMode === mode) {
                el.classList.remove('hidden');
                if(mode==='input') this.renderInput();
                if(mode==='sheet') this.renderSheet();
                if(mode==='settings') this.renderSettings();
                if(mode==='history') this.renderHistory();
            } else {
                el.classList.add('hidden');
            }
        });
        document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`btn-${this.state.viewMode}`).classList.add('active');
    }

    renderInput() {
        const teamA = this.state.teamA, teamB = this.state.teamB;
        document.getElementById('input-team-a-name').innerText = teamA.name;
        document.getElementById('input-team-b-name').innerText = teamB.name;
        document.getElementById('input-score-a').innerText = this.calculateTotalScore('A');
        document.getElementById('input-score-b').innerText = this.calculateTotalScore('B');
        document.getElementById('input-foul-a').innerText = teamA.teamFouls[this.state.quarter] || 0;
        document.getElementById('input-foul-b').innerText = teamB.teamFouls[this.state.quarter] || 0;
        const half = this.getHalfKey(this.state.quarter);
        document.getElementById('input-to-a').innerText = (teamA.timeouts[half] || []).length;
        document.getElementById('input-to-b').innerText = (teamB.timeouts[half] || []).length;
        document.getElementById('input-quarter').innerText = `Q${this.state.quarter}`;

        const cardA = document.getElementById('team-a-card'), cardB = document.getElementById('team-b-card');
        if(this.state.selectedTeam === 'A') { cardA.classList.add('selected'); cardB.classList.remove('selected'); }
        else { cardB.classList.add('selected'); cardA.classList.remove('selected'); }

        this.renderPlayerGrid();
        this.renderInputControls();
    }

    renderPlayerGrid() {
        const team = this.state[this.state.selectedTeam === 'A' ? 'teamA' : 'teamB'];
        const displayPlayers = team.players.filter(p => p.number);
        const grid = document.getElementById('player-grid');
        document.getElementById('player-list-title').innerText = `${team.name} 選手`;

        if (displayPlayers.length === 0) {
            grid.innerHTML = '<div class="text-center text-gray-500 py-4 text-sm col-span-3">登録選手なし<br>設定で番号を入力</div>';
            return;
        }

        grid.innerHTML = displayPlayers.map(p => {
            const isSel = this.state.selectedPlayerId === p.id;
            const isOut = p.fouls.length >= 5;
            const dots = p.fouls.map(() => `<div class="w-2 h-2 rounded-full ${isSel?'bg-yellow-200':'bg-yellow-500'}"></div>`).join('');
            return `
                <button onclick="app.selectPlayer('${p.id}')" class="player-btn ${isSel?'selected':''} ${isOut?'disabled':''}">
                    ${p.isCaptain ? `<span class="absolute top-1 left-1 text-[10px] font-bold px-1 rounded ${isSel?'bg-yellow-400 text-blue-900':'bg-yellow-200'}">C</span>` : ''}
                    <span class="text-xl font-bold font-mono">#${p.number}</span>
                    <span class="text-xs truncate w-full text-center">${p.name||'-'}</span>
                    <div class="flex gap-1 mt-1 h-2">${dots} ${isOut?'<span class="text-red font-bold text-xs">OUT</span>':''}</div>
                </button>
            `;
        }).join('');
    }

    renderInputControls() {
        const team = this.state[this.state.selectedTeam === 'A' ? 'teamA' : 'teamB'];
        const player = team.players.find(p => p.id === this.state.selectedPlayerId);
        document.getElementById('selected-player-name').innerText = player ? `#${player.number} ${player.name}` : '未選択';
        
        const disabled = !player || player.fouls.length >= 5;
        document.querySelectorAll('.control-btn.btn-green, .control-btn.btn-yellow').forEach(b => b.disabled = disabled);
        
        const half = this.getHalfKey(this.state.quarter);
        const limit = half === 1 ? 2 : 3;
        document.getElementById('to-btn-text-a').innerText = `${this.state.teamA.timeouts[half].length}/${limit}`;
        document.getElementById('to-btn-text-b').innerText = `${this.state.teamB.timeouts[half].length}/${limit}`;
    }

    renderSheet() {
        const g = this.state;
        
        // Helper to render team section (Restored Logic)
        const renderTeamSection = (teamKey) => {
            const team = g[teamKey === 'A' ? 'teamA' : 'teamB'];
            const registeredPlayers = team.players.filter(p => p.number);
            
            // Player rows (fixed 18 rows)
            let playerRows = '';
            for(let i=0; i<18; i++) {
                const p = registeredPlayers[i];
                if(p) {
                    const foulCells = [1,2,3,4,5].map(n => 
                        `<div class="flex-1 border border-gray-400 h-3 w-3 flex items-center justify-center text-[8px]">${p.fouls[n-1] || ''}</div>`
                    ).join('');
                    
                    playerRows += `
                        <tr style="height:14px; border-bottom:1px solid #9ca3af;">
                            <td class="text-center font-mono">${i+1}</td>
                            <td class="text-left pl-1 relative">
                                ${p.name} ${p.isCaptain ? '<span class="text-[8px] font-bold">(CAP)</span>' : ''}
                            </td>
                            <td class="text-center font-bold font-mono">${p.number}</td>
                            <td><div class="flex justify-center gap-1">${foulCells}</div></td>
                        </tr>
                    `;
                } else {
                    playerRows += `
                        <tr style="height:14px; border-bottom:1px solid #9ca3af;">
                            <td class="text-center">${registeredPlayers.length + (i - registeredPlayers.length) + 1}</td>
                            <td></td><td></td>
                            <td><div class="flex justify-center gap-1">${[1,2,3,4,5].map(()=>'<div class="h-3 w-3 border border-gray-400"></div>').join('')}</div></td>
                        </tr>
                    `;
                }
            }

            // Team fouls and timeouts
            const to1 = team.timeouts[1] || [];
            const to2 = team.timeouts[2] || [];
            const tf = team.teamFouls;

            return `
                <div class="mb-2">
                    <div class="flex justify-between items-end border-b border-black mb-1">
                        <div class="font-bold text-sm pb-1">
                            <span class="text-xs mr-2">チーム${teamKey}</span>
                            <span class="text-xs mr-1">Team ${teamKey}:</span>
                            <span class="text-lg font-serif uppercase">${team.name}</span>
                        </div>
                        <div class="text-[10px] pb-1">Color: ${team.color}</div>
                    </div>
                    <div class="flex text-[10px] mb-1 justify-between items-start">
                        <div class="w-[45%]">
                            <div class="font-bold text-[9px] mb-1">タイムアウト Time-outs</div>
                            <div class="flex gap-1 mb-1 items-center">
                                <div class="border border-black w-6 h-4 text-center font-bold">${to1[0]||''}</div>
                                <div class="border border-black w-6 h-4 text-center font-bold">${to1[1]||''}</div>
                            </div>
                            <div class="flex gap-1 items-center">
                                <div class="border border-black w-6 h-4 text-center font-bold">${to2[0]||''}</div>
                                <div class="border border-black w-6 h-4 text-center font-bold">${to2[1]||''}</div>
                                <div class="border border-black w-6 h-4 text-center font-bold">${to2[2]||''}</div>
                            </div>
                        </div>
                        <div class="w-[50%]">
                            <div class="font-bold text-[9px] mb-1">チームファウル Team Fouls</div>
                            <div class="flex gap-1 mb-1 items-center">
                                <span class="w-4 text-right">1</span>
                                <div class="border border-black w-6 h-4 text-center">${tf[1] > 0 ? (tf[1]>4?5:tf[1]) : ''}</div>
                                <span class="w-4 text-right ml-2">2</span>
                                <div class="border border-black w-6 h-4 text-center">${tf[2] > 0 ? (tf[2]>4?5:tf[2]) : ''}</div>
                            </div>
                            <div class="flex gap-1 items-center">
                                <span class="w-4 text-right">3</span>
                                <div class="border border-black w-6 h-4 text-center">${tf[3] > 0 ? (tf[3]>4?5:tf[3]) : ''}</div>
                                <span class="w-4 text-right ml-2">4</span>
                                <div class="border border-black w-6 h-4 text-center">${tf[4] > 0 ? (tf[4]>4?5:tf[4]) : ''}</div>
                            </div>
                        </div>
                    </div>
                    <table class="sheet-table">
                        <thead>
                            <tr>
                                <th style="width:20px;">No.</th>
                                <th>選手氏名 Name of Players</th>
                                <th style="width:25px;">No.</th>
                                <th style="width:70px;">ファウル Fouls</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${playerRows}
                            <tr style="height:20px; border-top:2px solid black;">
                                <td colspan="2" class="text-left pl-1 border-r border-black font-bold">コーチ Coach: <span class="font-normal ml-1">${team.coach}</span></td>
                                <td colspan="2"></td>
                            </tr>
                            <tr style="height:20px;">
                                <td colspan="2" class="text-left pl-1 border-r border-black font-bold">A.コーチ A.Coach: <span class="font-normal ml-1">${team.assistantCoach}</span></td>
                                <td colspan="2"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
        };

        // Helper for running score (Restored Logic)
        const renderRunningScore = () => {
            const data = [];
            let cA = 0, cB = 0;
            for(let i=1; i<=160; i++) data.push({s:i, a:null, b:null});
            g.scores.forEach(s => {
                const isA = s.team === 'A';
                const score = (isA ? cA : cB) + s.points;
                if(isA) { if(data[score-1]) data[score-1].a = s; cA = score; }
                else { if(data[score-1]) data[score-1].b = s; cB = score; }
            });

            const renderCol = (start, end) => {
                const rows = data.slice(start-1, end).map(d => {
                    const qa = d.a ? (d.a.quarter===1||d.a.quarter===3 ? 'text-red-print' : '') : '';
                    const qb = d.b ? (d.b.quarter===1||d.b.quarter===3 ? 'text-red-print' : '') : '';
                    return `
                        <div class="running-row">
                            <div class="running-cell num ${qa}" style="border-right:1px solid #d1d5db;">${d.a ? d.a.playerNumber : ''}</div>
                            <div class="running-cell score bg-gray-100 ${qa}" style="border-right:1px solid #d1d5db;">${d.a ? d.s : ''}</div>
                            <div class="running-cell score bg-gray-100 ${qb}" style="border-right:1px solid #d1d5db;">${d.b ? d.s : ''}</div>
                            <div class="running-cell num ${qb}">${d.b ? d.b.playerNumber : ''}</div>
                        </div>
                    `;
                }).join('');
                return `
                    <div class="running-col">
                        <div class="running-row bg-gray-100 font-bold border-b border-black">
                            <div class="running-cell">A</div><div class="running-cell" style="flex:2">score</div><div class="running-cell">B</div>
                        </div>
                        ${rows}
                    </div>
                `;
            };

            return `
                <div class="running-score-grid">
                    ${renderCol(1,40)}
                    ${renderCol(41,80)}
                    ${renderCol(81,120)}
                    ${renderCol(121,160)}
                </div>
            `;
        };

        const totalA = this.calculateTotalScore('A');
        const totalB = this.calculateTotalScore('B');
        const winner = totalA > totalB ? g.teamA.name : (totalB > totalA ? g.teamB.name : '');

        const html = `
            <div class="text-center border-b-2 border-black pb-2 mb-2">
                <h1 class="font-bold text-xl uppercase tracking-widest mb-2">OFFICIAL SCORESHEET</h1>
                <div class="flex justify-between items-end text-[10px] mb-2 px-2">
                    <div class="flex flex-col gap-1 text-left w-1/3">
                        <div><span class="font-bold w-16">チームA:</span> <span class="border-b border-gray-400 px-1">${g.teamA.name}</span></div>
                        <div><span class="font-bold w-16">大会名:</span> <span class="border-b border-gray-400 px-1">${g.gameInfo.competition}</span></div>
                        <div><span class="font-bold w-16">Game No.:</span> <span class="border-b border-gray-400 px-1">${g.gameInfo.gameNo}</span></div>
                    </div>
                    <div class="flex flex-col gap-1 text-center w-1/3">
                        <div><span>日付:</span> <span class="border-b border-gray-400 px-2">${g.gameInfo.date}</span> <span>時間:</span> <span class="border-b border-gray-400 px-2">${g.gameInfo.time}</span></div>
                        <div><span>場所:</span> <span class="border-b border-gray-400 px-2">${g.gameInfo.place}</span></div>
                    </div>
                    <div class="flex flex-col gap-1 text-right w-1/3">
                         <div><span class="font-bold w-16 mr-1">チームB:</span> <span class="border-b border-gray-400 px-1 text-left">${g.teamB.name}</span></div>
                    </div>
                </div>
                <div class="flex justify-between text-[9px] border border-black p-1 px-4">
                     <div><span class="font-bold">クルーチーフ:</span> <span class="border-b border-gray-400 px-2">${g.gameInfo.crewChief}</span></div>
                     <div><span class="font-bold">1st アンパイア:</span> <span class="border-b border-gray-400 px-2">${g.gameInfo.umpire1}</span></div>
                     <div><span class="font-bold">2nd アンパイア:</span> <span class="border-b border-gray-400 px-2">${g.gameInfo.umpire2}</span></div>
                </div>
            </div>

            <div class="flex h-full">
                <div class="w-[45%] flex flex-col pr-2">
                    ${renderTeamSection('A')}
                    <div class="h-2"></div>
                    ${renderTeamSection('B')}
                    
                    <div class="mt-2 border-2 border-black text-[9px]">
                        <div class="flex bg-gray-100 font-bold border-b border-black text-center">
                            <div class="w-1/4 border-r border-black">スコア</div>
                            <div class="flex-1 border-r border-gray-300">1Q</div>
                            <div class="flex-1 border-r border-gray-300">2Q</div>
                            <div class="flex-1 border-r border-gray-300">3Q</div>
                            <div class="flex-1">4Q</div>
                        </div>
                        <div class="flex text-center border-b border-gray-300 h-6 items-center">
                            <div class="w-1/4 border-r border-black font-bold">A</div>
                            <div class="flex-1 border-r border-gray-300">${this.calculateQuarterScore('A',1)}</div>
                            <div class="flex-1 border-r border-gray-300">${this.calculateQuarterScore('A',2)}</div>
                            <div class="flex-1 border-r border-gray-300">${this.calculateQuarterScore('A',3)}</div>
                            <div class="flex-1">${this.calculateQuarterScore('A',4)}</div>
                        </div>
                        <div class="flex text-center border-b border-black h-6 items-center">
                            <div class="w-1/4 border-r border-black font-bold">B</div>
                            <div class="flex-1 border-r border-gray-300">${this.calculateQuarterScore('B',1)}</div>
                            <div class="flex-1 border-r border-gray-300">${this.calculateQuarterScore('B',2)}</div>
                            <div class="flex-1 border-r border-gray-300">${this.calculateQuarterScore('B',3)}</div>
                            <div class="flex-1">${this.calculateQuarterScore('B',4)}</div>
                        </div>
                        <div class="p-1 font-bold text-center bg-gray-100 border-b border-black">
                             最終スコア A: <span class="text-lg">${totalA}</span> - <span class="text-lg">${totalB}</span> : B
                        </div>
                        <div class="p-1 flex justify-between border-b border-black">
                            <span>勝者: ${winner}</span>
                            <span>終了時間: ${g.gameInfo.endTime}</span>
                        </div>
                    </div>
                </div>
                <div class="w-[55%] flex flex-col">
                    <div class="text-center font-bold text-sm bg-gray-100 border-x border-t border-black">ランニングスコア</div>
                    ${renderRunningScore()}
                </div>
            </div>
            
            <div class="mt-2 border border-black p-1 text-[9px] flex justify-between">
                <div class="flex gap-4">
                    <span>スコアラー: <span class="border-b border-gray-400 px-1">${g.gameInfo.scorer}</span></span>
                    <span>タイマー: <span class="border-b border-gray-400 px-1">${g.gameInfo.timer}</span></span>
                </div>
                <div class="flex gap-4">
                     <div class="text-center"><span class="border-b border-black block w-16 h-3"></span><span class="text-[8px]">クルーチーフ</span></div>
                </div>
            </div>
        `;
        document.getElementById('sheet-content').innerHTML = html;
    }

    renderSettings() {
        const t = this.state.settingsTab;
        const el = document.getElementById('settings-content');
        ['Info', 'A', 'B'].forEach(k => {
            const b = document.getElementById(`tab-${k.toLowerCase()}`);
            b.className = `flex-1 py-2 font-bold text-center ${t===k ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-500'}`;
        });

        if (t === 'Info') {
            const i = this.state.gameInfo;
            el.innerHTML = `
                <div class="grid grid-cols-1 gap-3">
                    <div><label class="text-xs text-gray-500">大会名</label><input type="text" value="${i.competition}" onchange="app.updateGameInfo('competition',this.value)"></div>
                    <div class="grid grid-cols-2 gap-2">
                        <div><label class="text-xs text-gray-500">日付</label><input type="date" value="${i.date}" onchange="app.updateGameInfo('date',this.value)"></div>
                        <div><label class="text-xs text-gray-500">時間</label><input type="time" value="${i.time}" onchange="app.updateGameInfo('time',this.value)"></div>
                    </div>
                    <div><label class="text-xs text-gray-500">会場</label><input type="text" value="${i.place}" onchange="app.updateGameInfo('place',this.value)"></div>
                    <div><label class="text-xs text-gray-500">審判 (Crew Chief)</label><input type="text" value="${i.crewChief}" onchange="app.updateGameInfo('crewChief',this.value)"></div>
                </div>
            `;
        } else {
            const team = this.state[t==='A'?'teamA':'teamB'];
            const rows = team.players.map(p => `
                <tr class="border-t">
                    <td class="p-1 text-center"><button onclick="app.toggleCaptain('${t}','${p.id}')" class="${p.isCaptain?'text-yellow-500':'text-gray-300'}">★</button></td>
                    <td class="p-1"><input type="text" class="text-center p-1" placeholder="-" value="${p.number}" onchange="app.updatePlayer('${t}','${p.id}','number',this.value)"></td>
                    <td class="p-1"><input type="text" class="p-1" placeholder="名前" value="${p.name}" onchange="app.updatePlayer('${t}','${p.id}','name',this.value)"></td>
                </tr>
            `).join('');
            el.innerHTML = `
                <div class="mb-4 space-y-2">
                    <div><label class="text-xs text-gray-500">チーム名</label><input type="text" value="${team.name}" onchange="app.updateTeamInfo('${t}','name',this.value)"></div>
                    <div><label class="text-xs text-gray-500">カラー</label><input type="text" value="${team.color}" onchange="app.updateTeamInfo('${t}','color',this.value)"></div>
                </div>
                <table class="w-full text-sm">
                    <thead class="bg-gray-100"><tr><th width="30">C</th><th width="50">No</th><th>Name</th></tr></thead>
                    <tbody>${rows}</tbody>
                </table>
            `;
        }
    }

    renderHistory() {
        const el = document.getElementById('history-list');
        if (this.savedGames.length === 0) { el.innerHTML = '<div class="text-center py-8 text-gray-500">データなし</div>'; return; }
        el.innerHTML = this.savedGames.map(g => `
            <div class="bg-white p-3 rounded shadow border">
                <div class="font-bold text-blue-900">${g.title}</div>
                <div class="text-xs text-gray-500 mb-2">${new Date(g.createdAt).toLocaleString()}</div>
                <div class="flex gap-2">
                    <button class="bg-blue-100 text-blue-800 px-3 py-1 rounded text-xs flex-1" onclick="app.loadGame('${g.id}')">開く</button>
                    <button class="bg-red-100 text-red-800 px-3 py-1 rounded text-xs" onclick="app.deleteGame('${g.id}')">削除</button>
                </div>
            </div>
        `).join('');
    }
}

const app = new ScoreApp();
</script>
</body>
</html>

