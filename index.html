<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BasketScore Final (Color Coded)</title>
<style>
    /* --- CSS Reset & Base --- */
    * { box-sizing: border-box; }
    body { 
        margin: 0; padding: 0; 
        font-family: "Times New Roman", "YuMincho", "Hiragino Mincho ProN", "Yu Mincho", "MS PMincho", serif;
        background-color: #333; 
        color: #000;
        -webkit-font-smoothing: antialiased;
        height: 100vh; overflow: hidden;
    }
    
    .ui-font { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }

    /* --- Navbar --- */
    nav { 
        background-color: #111; color: white; padding: 0 10px; 
        display: flex; justify-content: space-between; align-items: center;
        height: 40px; border-bottom: 1px solid #444; flex-shrink: 0;
    }
    .nav-title { font-weight: bold; font-size: 1rem; }
    .nav-group { display: flex; gap: 2px; background: #222; padding: 2px; border-radius: 4px; }
    
    .btn { 
        padding: 4px 10px; border-radius: 4px; border: none; cursor: pointer; 
        font-size: 0.85rem; font-weight: bold; transition: background 0.1s;
        display: inline-flex; align-items: center; justify-content: center; gap: 4px; text-decoration: none;
        white-space: nowrap;
    }
    .btn-nav { background: transparent; color: #888; }
    .btn-nav.active { background: #444; color: white; }
    .btn-primary { background-color: #2563eb; color: white; }
    .btn-danger { background-color: #dc2626; color: white; }
    .btn-warning { background-color: #eab308; color: white; }
    .btn-secondary { background-color: #4b5563; color: white; }
    
    /* --- Main Container --- */
    #app-container {
        height: calc(100vh - 40px);
        display: flex; flex-direction: column; background: #f0f0f0;
    }

    /* --- INPUT VIEW --- */
    #input-view {
        display: grid;
        grid-template-columns: 1fr 150px 1fr;
        gap: 2px; height: 100%; background: #ccc; overflow: hidden;
    }
    .team-col { background: #fff; display: flex; flex-direction: column; overflow: hidden; }
    .team-header {
        padding: 5px 10px; background: #222; color: white;
        display: flex; justify-content: space-between; align-items: center;
        height: 40px; flex-shrink: 0;
    }
    .th-name { font-weight: bold; font-size: 0.9rem; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
    .th-score { font-size: 1.5rem; font-weight: bold; color: #fbbf24; line-height: 1; }
    .th-sub { font-size: 0.7rem; color: #aaa; }

    .player-list {
        flex: 1; overflow-y: auto; padding: 5px;
        display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        grid-auto-rows: minmax(70px, 1fr); gap: 5px; align-content: start;
    }
    .p-btn {
        background: #f9fafb; border: 1px solid #ddd; border-radius: 4px;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        cursor: pointer; position: relative; user-select: none;
        transition: transform 0.05s, background 0.1s;
    }
    .p-btn:active { transform: scale(0.98); }
    
    /* Active States for Colors */
    .p-btn.active-a { background: #2563eb; color: white; border-color: #1d4ed8; box-shadow: inset 0 0 5px rgba(0,0,0,0.2); }
    .p-btn.active-b { background: #dc2626; color: white; border-color: #b91c1c; box-shadow: inset 0 0 5px rgba(0,0,0,0.2); }
    
    .p-btn.out { opacity: 0.5; background: #fee2e2; }
    .p-no { font-size: 1.4rem; font-weight: bold; font-family: monospace; line-height: 1; }
    .p-name { font-size: 0.7rem; width: 100%; text-align: center; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
    .p-dots { display: flex; gap: 2px; margin-top: 2px; height: 5px; }
    .dot { width: 5px; height: 5px; border-radius: 50%; background: #e5e7eb; }
    .dot.on { background: #eab308; }
    .p-mark { position: absolute; top: 2px; left: 2px; font-size: 0.6rem; font-weight: bold; color: #eab308; }

    .center-col { background: #e5e7eb; display: flex; flex-direction: column; padding: 5px; gap: 5px; overflow-y: auto; }
    .q-box { display: flex; justify-content: space-between; align-items: center; background: #333; color: white; padding: 5px; border-radius: 4px; flex-shrink: 0; }
    .info-box { background: white; border-radius: 4px; padding: 5px; text-align: center; border: 1px solid #ccc; flex-shrink: 0; }
    
    .sel-info { height: 1.2rem; font-weight: bold; font-size: 0.9rem; color: #666; overflow: hidden; white-space: nowrap; }
    .sel-info.team-a { color: #2563eb; }
    .sel-info.team-b { color: #dc2626; }
    
    .btn-col { display: flex; flex-direction: column; gap: 4px; flex: 1; }
    .grp-lbl { font-size: 0.7rem; font-weight: bold; color: #555; text-align: center; margin-bottom: 2px; }
    .act-btn {
        flex: 1; min-height: 40px; border-radius: 4px; border: none; cursor: pointer; font-weight: bold;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1); transition: background 0.1s;
    }
    .act-score { background: #16a34a; color: white; font-size: 1.1rem; }
    .act-score span { font-size: 0.6rem; opacity: 0.9; font-weight: normal; }
    .act-foul { background: #eab308; color: white; font-size: 0.9rem; }
    .act-spec { background: #f59e0b; color: white; font-size: 0.8rem; }
    
    .bottom-ctrl { margin-top: auto; display: flex; flex-direction: column; gap: 5px; }
    .to-row { display: flex; gap: 2px; }
    .to-btn { flex: 1; font-size: 0.7rem; padding: 8px 0; background: #fff; border: 1px solid #ccc; }

    /* --- SETTINGS VIEW --- */
    #settings-view { overflow-y: auto; padding: 20px; display: none; background: #f3f4f6; }
    .set-box { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .form-row { display: flex; gap: 10px; margin-bottom: 10px; }
    .form-grp { flex: 1; }
    .form-lbl { font-size: 0.75rem; font-weight: bold; display: block; margin-bottom: 2px; }
    .form-inp { width: 100%; padding: 5px; font-size: 0.9rem; border: 1px solid #ccc; border-radius: 4px; }
    .tbl-set { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
    .tbl-set th { background: #eee; padding: 4px; text-align: center; font-weight: bold; }
    .tbl-set td { border-bottom: 1px solid #eee; padding: 2px; text-align: center; }
    .inp-cell { width: 100%; border: 1px solid transparent; padding: 4px; text-align: center; }
    .inp-cell:focus { border-color: #2563eb; background: #eff6ff; }

    /* --- HISTORY VIEW --- */
    #history-view { display: none; padding: 20px; overflow-y: auto; background: #f3f4f6; }
    .hist-list { max-width: 800px; margin: 0 auto; display: flex; flex-direction: column; gap: 10px; }
    .hist-card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
    
    /* --- SHEET VIEW --- */
    #sheet-view { display: none; justify-content: center; padding: 20px; overflow: auto; background: #525659; }
    .paper-a4 {
        width: 210mm; height: 297mm; background: white; padding: 10mm;
        box-shadow: 0 0 15px rgba(0,0,0,0.5); box-sizing: border-box;
        display: flex; flex-direction: column; font-size: 10px; line-height: 1.1;
    }
    
    /* Sheet Utils */
    .s-row { display: flex; width: 100%; }
    .bd { border: 1px solid #000; }
    .bt { border-top: 1px solid #000; }
    .bb { border-bottom: 1px solid #000; }
    .bl { border-left: 1px solid #000; }
    .br { border-right: 1px solid #000; }
    .txt-c { text-align: center; }
    .txt-b { font-weight: bold; }
    .bg-g { background: #eee; }
    .text-red { color: #dc2626 !important; }
    
    /* Visual Symbols for Running Score */
    .slash { 
        background: linear-gradient(to top right, transparent calc(50% - 0.5px), black calc(50% - 0.5px), black calc(50% + 0.5px), transparent calc(50% + 0.5px)); 
    }
    .slash-red {
        background: linear-gradient(to top right, transparent calc(50% - 0.5px), #dc2626 calc(50% - 0.5px), #dc2626 calc(50% + 0.5px), transparent calc(50% + 0.5px)); 
    }
    .circle-num {
        border: 1px solid black; border-radius: 50%; width: 14px; height: 14px; display: inline-flex; align-items: center; justify-content: center; line-height: 1; margin: 0 auto;
    }
    .circle-num-red {
        border: 1px solid #dc2626; color: #dc2626; border-radius: 50%; width: 14px; height: 14px; display: inline-flex; align-items: center; justify-content: center; line-height: 1; margin: 0 auto;
    }
    .filled-dot {
        width: 6px; height: 6px; background: black; border-radius: 50%; margin: auto;
    }
    .filled-dot-red {
        width: 6px; height: 6px; background: #dc2626; border-radius: 50%; margin: auto;
    }

    /* Pl-in Circle for Starter */
    .starter-mark {
        width: 12px; height: 12px; border: 1px solid #dc2626; border-radius: 50%; color: #dc2626; font-size: 9px; line-height: 11px; text-align: center; display: inline-block;
    }

    @media print {
        @page { size: A4 portrait; margin: 0; }
        body { background: white; height: auto; overflow: visible; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        nav, #input-view, #settings-view, #history-view { display: none !important; }
        #app-container { height: auto; display: block; }
        #sheet-view { display: block !important; padding: 0; margin: 0; overflow: visible; height: auto; }
        .paper-a4 { box-shadow: none; margin: 0; width: 210mm; height: 297mm; page-break-after: always; }
    }
</style>
</head>
<body>

<nav class="ui-font">
    <div class="nav-title">BasketScore</div>
    <div class="nav-group">
        <button class="btn btn-nav active" id="nav-input" onclick="setView('input')">入力</button>
        <button class="btn btn-nav" id="nav-sheet" onclick="setView('sheet')">シート</button>
        <button class="btn btn-nav" id="nav-settings" onclick="setView('settings')">設定</button>
        <button class="btn btn-nav" id="nav-history" onclick="setView('history')">履歴</button>
    </div>
    <div style="display:flex; gap:5px;">
        <button class="btn btn-secondary" onclick="newGame()">新規</button>
        <button class="btn btn-primary" onclick="saveGame()">保存</button>
    </div>
</nav>

<div id="app-container" class="ui-font">

    <!-- INPUT VIEW -->
    <div id="input-view">
        <div class="team-col">
            <div class="team-header">
                <div style="width:70%;">
                    <div class="th-name" id="name-a">TEAM A</div>
                    <div class="th-sub">Fouls: <span id="foul-a">0</span></div>
                </div>
                <div class="th-score" id="score-a">0</div>
            </div>
            <div id="list-a" class="player-list"></div>
        </div>

        <div class="center-col">
            <div class="q-box">
                <div style="font-weight:bold; font-size:1.2rem; color:#ef4444;" id="disp-q">Q1</div>
                <button class="btn btn-secondary" onclick="nextQ()">Next</button>
            </div>
            <div class="info-box">
                <div style="font-size:0.65rem; color:#666;">SELECT</div>
                <div class="sel-info" id="sel-name">---</div>
            </div>
            
            <div class="btn-col" style="flex:1;">
                <div class="grp-lbl">SCORE (得点)</div>
                <button class="act-btn act-score" onclick="actScore(1)">+1 <span>FT ●</span></button>
                <button class="act-btn act-score" onclick="actScore(2)">+2 <span>FG ／</span></button>
                <button class="act-btn act-score" onclick="actScore(3)">+3 <span>3P ○</span></button>
            </div>

            <div class="btn-col" style="flex:1.2;">
                <div class="grp-lbl">FOUL (ファウル)</div>
                <div style="display:flex; gap:2px; flex:1;">
                    <button class="act-btn act-foul" onclick="actFoul('P')">P</button>
                    <button class="act-btn act-foul" onclick="actFoul('P1')">P1</button>
                    <button class="act-btn act-foul" onclick="actFoul('P2')">P2</button>
                </div>
                <div style="display:flex; gap:2px; flex:1;">
                    <button class="act-btn act-spec" onclick="actFoul('T1')">T1</button>
                    <button class="act-btn act-spec" onclick="actFoul('U2')">U2</button>
                    <button class="act-btn act-spec" onclick="actFoul('D2')">D2</button>
                </div>
            </div>

            <div class="bottom-ctrl">
                <div class="to-row">
                    <button class="btn to-btn" onclick="actTO('A')">A TimeOut</button>
                    <button class="btn to-btn" onclick="actTO('B')">B TimeOut</button>
                </div>
                <button class="btn btn-danger" style="width:100%; padding:10px 0;" onclick="actUndo()">Undo (取消)</button>
            </div>
        </div>

        <div class="team-col">
            <div class="team-header">
                <div class="th-score" id="score-b">0</div>
                <div style="width:70%; text-align:right;">
                    <div class="th-name" id="name-b">TEAM B</div>
                    <div class="th-sub">Fouls: <span id="foul-b">0</span></div>
                </div>
            </div>
            <div id="list-b" class="player-list"></div>
        </div>
    </div>

    <!-- SETTINGS VIEW -->
    <div id="settings-view">
        <div class="set-box">
            <h3>試合設定</h3>
            <div class="form-row">
                <div class="form-grp"><label class="form-lbl">大会名</label><input class="form-inp" id="inp-comp" onchange="upMeta('competition', this.value)"></div>
            </div>
            <div class="form-row">
                <div class="form-grp"><label class="form-lbl">日付</label><input type="date" class="form-inp" id="inp-date" onchange="upMeta('date', this.value)"></div>
                <div class="form-grp"><label class="form-lbl">時間</label><input type="time" class="form-inp" id="inp-time" onchange="upMeta('time', this.value)"></div>
                <div class="form-grp"><label class="form-lbl">会場</label><input class="form-inp" id="inp-place" onchange="upMeta('place', this.value)"></div>
                <div class="form-grp"><label class="form-lbl">Game No</label><input class="form-inp" id="inp-no" onchange="upMeta('no', this.value)"></div>
            </div>
            <hr style="border:0; border-top:1px solid #ddd; margin:15px 0;">
            <div id="team-settings"></div>
            <hr style="border:0; border-top:1px solid #ddd; margin:15px 0;">
            <h3>審判・オフィシャル</h3>
            <div class="form-row">
                <div class="form-grp"><label class="form-lbl">クルーチーフ</label><input class="form-inp" id="inp-cc" onchange="upMeta('crewChief', this.value)"></div>
                <div class="form-grp"><label class="form-lbl">Umpire 1</label><input class="form-inp" id="inp-u1" onchange="upMeta('umpire1', this.value)"></div>
                <div class="form-grp"><label class="form-lbl">Umpire 2</label><input class="form-inp" id="inp-u2" onchange="upMeta('umpire2', this.value)"></div>
            </div>
            <div class="form-row">
                <div class="form-grp"><label class="form-lbl">スコアラー</label><input class="form-inp" id="inp-sc" onchange="upMeta('scorer', this.value)"></div>
                <div class="form-grp"><label class="form-lbl">タイマー</label><input class="form-inp" id="inp-tm" onchange="upMeta('timer', this.value)"></div>
            </div>
        </div>
    </div>

    <!-- HISTORY VIEW -->
    <div id="history-view">
        <div class="hist-list" id="hist-container"></div>
    </div>

    <!-- SHEET VIEW -->
    <div id="sheet-view">
        <button class="btn btn-warning" onclick="window.print()" style="position:fixed; bottom:20px; right:20px; box-shadow:0 2px 10px rgba(0,0,0,0.3); z-index:100;">印刷 (PDF)</button>
        <div id="sheet-paper" class="paper-a4"></div>
    </div>
</div>

<script>
// --- Logic ---
const createP = (i) => ({ no: '', name: '', capt: false, start: false, played: false, fouls: [], id: Math.random().toString(36).substr(2,9) });
const genId = () => Date.now().toString(36) + Math.random().toString(36).substr(2);
const todayStr = () => new Date().toISOString().split('T')[0];

const initSt = () => ({
    gameId: genId(), lastSaved: null,
    view: 'input', selT: null, selId: null,
    q: 1,
    meta: { competition:'', date:todayStr(), time:'', place:'', no:'', crewChief:'', umpire1:'', umpire2:'', scorer:'', timer:'', shotClock:'' },
    teamA: { name:'TEAM A', color:'', coach:'', ac:'', players:Array.from({length:18},(_,i)=>createP(i)), timeouts:{1:[],2:[]}, fouls:{1:0,2:0,3:0,4:0} },
    teamB: { name:'TEAM B', color:'', coach:'', ac:'', players:Array.from({length:18},(_,i)=>createP(i)), timeouts:{1:[],2:[]}, fouls:{1:0,2:0,3:0,4:0} },
    logs: [] // {q, team, pid, no, val, type} type: score(1,2,3), foul
});
let st = initSt();

// --- Persistence ---
function saveGame() {
    st.lastSaved = new Date().toISOString();
    let hist = [];
    try { hist = JSON.parse(localStorage.getItem('bss_hist_v2') || '[]'); } catch(e){}
    const idx = hist.findIndex(g => g.gameId === st.gameId);
    if(idx >= 0) hist[idx] = st; else hist.unshift(st);
    localStorage.setItem('bss_hist_v2', JSON.stringify(hist));
    alert('保存しました (履歴に追加)');
}
function loadGameList() { try { return JSON.parse(localStorage.getItem('bss_hist_v2') || '[]'); } catch(e){return[];} }
function loadGame(id) {
    if(!confirm('編集中の内容は破棄されます。よろしいですか？')) return;
    const g = loadGameList().find(x => x.gameId === id);
    if(g) { st = g; setView('input'); alert('読み込みました'); }
}
function deleteGame(id) {
    if(!confirm('削除しますか？')) return;
    const hist = loadGameList().filter(g => g.gameId !== id);
    localStorage.setItem('bss_hist_v2', JSON.stringify(hist));
    renHistory();
}
function newGame() {
    if(!confirm('新規作成しますか？')) return;
    st = initSt(); setView('input');
}

// --- Actions ---
function setView(v) {
    st.view = v;
    ['input','sheet','settings','history'].forEach(k => {
        const el = document.getElementById(k+'-view');
        if(el) el.style.display = k===v ? (k==='input'?'grid':(k==='sheet'?'flex':'block')) : 'none';
        document.getElementById('nav-'+k).classList.toggle('active', k===v);
    });
    if(v==='input') renInput();
    if(v==='settings') renSettings();
    if(v==='history') renHistory();
    if(v==='sheet') { renSheet(); fitSheet(); window.onresize = fitSheet; }
    else window.onresize = null;
}

function selP(tm, pid) { st.selT = tm; st.selId = pid; renInput(); }

function markPlayed(tm, pid) {
    const p = getP(tm, pid);
    if(p && !p.played) p.played = true;
}

function actScore(val) { // val: 1(FT), 2(FG), 3(3P)
    if(!st.selId) return;
    const p = getP(st.selT, st.selId);
    if(!p.no) return alert('背番号がありません');
    
    markPlayed(st.selT, st.selId);
    st.logs.push({ q:st.q, team:st.selT, pid:st.selId, no:p.no, val:val, type:'score' });
    renInput();
}

function actFoul(code) { // P, P1, P2, T1, U2, D2...
    if(!st.selId) return;
    const p = getP(st.selT, st.selId);
    if(p.fouls.length>=5) return alert('5ファウル済み');
    
    markPlayed(st.selT, st.selId);
    p.fouls.push(code); 
    const qMap = st.q>4?4:st.q;
    st[st.selT==='A'?'teamA':'teamB'].fouls[qMap]++;
    
    st.logs.push({ q:st.q, team:st.selT, pid:st.selId, no:p.no, val:0, type:'foul', code:code });
    renInput();
}

function actTO(tm) {
    const tk = tm==='A'?'teamA':'teamB';
    const h = st.q<=2?1:2;
    const min = prompt("経過時間(分)を入力してください (例: 5)", "");
    st[tk].timeouts[h].push(min || 'X');
    renInput();
}

function actUndo() {
    if(st.logs.length===0) return;
    const l = st.logs.pop();
    if(l.type==='foul') {
        const tk = l.team==='A'?'teamA':'teamB';
        const p = st[tk].players.find(x=>x.id===l.pid);
        if(p) p.fouls.pop();
        const qMap = l.q>4?4:l.q;
        st[tk].fouls[qMap]--;
    }
    renInput();
}

function nextQ() { st.q++; renInput(); }
function upMeta(k,v) { st.meta[k]=v; }
function upTeam(tm,k,v) { st[tm][k]=v; }
function upPlayer(tm,i,k,v) { st[tm].players[i][k]=v; }
function getP(tm, id) { return st[tm==='A'?'teamA':'teamB'].players.find(x=>x.id===id); }
function getScore(logs) {
    let a=0, b=0;
    (logs||st.logs).forEach(l=>{ if(l.type==='score') l.team==='A'?a+=l.val:b+=l.val; });
    return {a,b};
}

// --- Renderers ---
function renInput() {
    const sc = getScore();
    document.getElementById('score-a').innerText = sc.a;
    document.getElementById('score-b').innerText = sc.b;
    document.getElementById('name-a').innerText = st.teamA.name;
    document.getElementById('name-b').innerText = st.teamB.name;
    document.getElementById('foul-a').innerText = st.teamA.fouls[st.q]||0;
    document.getElementById('foul-b').innerText = st.teamB.fouls[st.q]||0;
    document.getElementById('disp-q').innerText = 'Q'+st.q;

    // Center Info Update
    const selInfo = document.getElementById('sel-name');
    if(st.selId) {
        const p = getP(st.selT, st.selId);
        selInfo.innerText = p ? `#${p.no} ${p.name}` : '---';
        
        // Color Change Logic
        selInfo.className = 'sel-info ' + (st.selT === 'A' ? 'team-a' : 'team-b');
    } else {
        selInfo.innerText = '---';
        selInfo.className = 'sel-info';
    }

    ['A','B'].forEach(tm => {
        const tk = tm==='A'?'teamA':'teamB';
        const players = st[tk].players.filter(p=>p.no!=='');
        const html = players.map(p => {
            // Determine active class based on team
            let activeClass = '';
            if (st.selId === p.id) {
                activeClass = (tm === 'A') ? 'active-a' : 'active-b';
            }
            
            return `
            <div class="p-btn ${activeClass} ${p.fouls.length>=5?'out':''}" onclick="selP('${tm}','${p.id}')">
                ${p.capt?'<div class="p-mark">CAP</div>':''}
                ${p.start?'<div style="position:absolute; bottom:2px; left:2px; font-size:0.6rem; color:red;">ST</div>':''}
                <div class="p-no">${p.no}</div>
                <div class="p-name">${p.name||'-'}</div>
                <div class="p-dots">
                    ${[1,2,3,4,5].map(i=>`<div class="dot ${i<=p.fouls.length?'on':''}"></div>`).join('')}
                </div>
            </div>
            `;
        }).join('');
        document.getElementById('list-'+tm.toLowerCase()).innerHTML = html;
    });
}

function renSettings() {
    ['comp','date','time','place','no','cc','u1','u2','sc','tm'].forEach(k => {
        const el = document.getElementById('inp-'+k);
        if(el) {
            const mk = k==='comp'?'competition':(k==='cc'?'crewChief':(k==='u1'?'umpire1':(k==='u2'?'umpire2':(k==='sc'?'scorer':(k==='tm'?'timer':k)))));
            el.value = st.meta[mk];
        }
    });

    let html = '';
    ['teamA','teamB'].forEach(tk => {
        html += `
        <div style="margin-bottom:20px;">
            <div style="font-weight:bold; border-bottom:1px solid #ddd; margin-bottom:10px;">${tk==='teamA'?'TEAM A':'TEAM B'}</div>
            <div class="form-row">
                <div class="form-grp"><label class="form-lbl">Team Name</label><input class="form-inp" value="${st[tk].name}" onchange="upTeam('${tk}','name',this.value)"></div>
                <div class="form-grp"><label class="form-lbl">Color</label><input class="form-inp" value="${st[tk].color}" onchange="upTeam('${tk}','color',this.value)"></div>
                <div class="form-grp"><label class="form-lbl">Coach</label><input class="form-inp" value="${st[tk].coach}" onchange="upTeam('${tk}','coach',this.value)"></div>
            </div>
            <table class="tbl-set">
                <thead><tr><th width="50">No</th><th>Name</th><th width="40">CAP</th><th width="40">Start</th></tr></thead>
                <tbody>
                ${st[tk].players.map((p,i) => `
                    <tr>
                        <td>
                            <select class="inp-cell" onchange="upPlayer('${tk}',${i},'no',this.value)">
                                <option value="">-</option>
                                ${Array.from({length:101},(_,n)=>`<option value="${n}" ${String(p.no)===String(n)?'selected':''}>${n}</option>`).join('')}
                            </select>
                        </td>
                        <td><input class="inp-cell" style="text-align:left;" value="${p.name}" onchange="upPlayer('${tk}',${i},'name',this.value)"></td>
                        <td><input type="checkbox" ${p.capt?'checked':''} onchange="upPlayer('${tk}',${i},'capt',this.checked)"></td>
                        <td><input type="checkbox" ${p.start?'checked':''} onchange="upPlayer('${tk}',${i},'start',this.checked)"></td>
                    </tr>
                `).join('')}
                </tbody>
            </table>
        </div>`;
    });
    document.getElementById('team-settings').innerHTML = html;
}

function renHistory() {
    const hist = loadGameList();
    const cont = document.getElementById('hist-container');
    if(hist.length===0) { cont.innerHTML = '<div style="text-align:center; color:#666;">保存なし</div>'; return; }
    cont.innerHTML = hist.map(g => {
        const sc = getScore(g.logs);
        return `
        <div class="hist-card">
            <div>
                <div style="font-size:0.8rem; color:#666;">${g.meta.date}</div>
                <div style="font-weight:bold;">${g.teamA.name} vs ${g.teamB.name}</div>
                <div style="font-family:monospace; font-weight:bold; color:#059669;">${sc.a} - ${sc.b}</div>
            </div>
            <div style="display:flex; gap:5px;">
                <button class="btn btn-primary" onclick="loadGame('${g.gameId}')">開く</button>
                <button class="btn btn-danger" onclick="deleteGame('${g.gameId}')">削除</button>
            </div>
        </div>`;
    }).join('');
}

function renSheet() {
    // Calc Running
    const run = Array.from({length:160},(_,i)=>({sc:i+1,a:null,b:null}));
    let cA=0, cB=0;
    const sumA={1:0,2:0,3:0,4:0}, sumB={1:0,2:0,3:0,4:0};

    st.logs.forEach(l => {
        if(l.type==='score') {
            const isA = l.team==='A';
            const s = isA?cA:cB; 
            const e = s+l.val;
            if(l.q<=4) (isA?sumA:sumB)[l.q]+=l.val;
            
            // Running Score Logic with Symbols and Colors
            const item = { no:l.no, q:l.q, type:l.val }; // 1=FT, 2=FG, 3=3P
            if(isA) { if(run[e-1]) run[e-1].a=item; cA=e; }
            else    { if(run[e-1]) run[e-1].b=item; cB=e; }
        }
    });

    const getP = (p) => `
        <div class="s-row bb" style="height:4.8mm;">
            <div class="br txt-c" style="width:20px; font-weight:bold; line-height:4.8mm;">${p.no}</div>
            <div class="br txt-c" style="width:16px; font-size:9px; line-height:4.8mm; color:#dc2626;">
                ${p.start ? '<span class="starter-mark">✕</span>' : (p.played ? '✕' : '')}
            </div>
            <div class="br" style="flex:1; overflow:hidden; white-space:nowrap; padding-left:2px; font-size:8px; line-height:4.8mm;">
                ${p.name} ${p.capt?'(CAP)':''}
            </div>
            <div class="br txt-c" style="width:20px; font-weight:bold; line-height:4.8mm;">${p.no}</div>
            ${[0,1,2,3,4].map(i=>`<div class="br txt-c" style="width:14px; font-size:8px; line-height:4.8mm;">${p.fouls[i]||''}</div>`).join('')}
        </div>`;
    
    const getTm = (tk, ttl) => `
        <div style="margin-bottom:3mm;">
            <div class="s-row bb" style="align-items:end; margin-bottom:1px;">
                <div style="font-size:9px;">${ttl}</div>
                <div style="font-weight:bold; font-size:12px; margin-left:10px; text-transform:uppercase;">${st[tk].name}</div>
                <div style="font-size:8px; margin-left:auto;">Color: ${st[tk].color}</div>
            </div>
            <div class="s-row" style="font-size:8px; margin-bottom:2px; justify-content:space-between;">
                <div style="display:flex; gap:2px;">
                    <strong>TO:</strong>
                    ${[0,1].map(i=> {
                        const v = st[tk].timeouts[1][i];
                        return `<div class="bd txt-c" style="width:12px;">${v||''}</div>`;
                    }).join('')}
                    <span style="font-size:7px;">(1-2)</span>
                    ${[0,1,2].map(i=>`<div class="bd txt-c" style="width:12px;">${st[tk].timeouts[2][i]||''}</div>`).join('')}
                    <span style="font-size:7px;">(3-4)</span>
                </div>
                <div style="display:flex; gap:2px;">
                    <strong>Fouls:</strong>
                    ${[1,2,3,4].map(q=>`<span style="margin-left:2px;">${q}</span><div class="bd txt-c ${(q===1||q===3)?'text-red':''}" style="width:12px;">${st[tk].fouls[q]>0?(st[tk].fouls[q]>4?5:st[tk].fouls[q]):''}</div>`).join('')}
                </div>
            </div>
            <div class="bd">
                <div class="s-row bb bg-g" style="font-size:7px; font-weight:bold; height:5mm; align-items:center;">
                    <div class="br txt-c" style="width:20px;">No</div>
                    <div class="br txt-c" style="width:16px;">Pl-in</div>
                    <div class="br txt-c" style="flex:1;">Name</div>
                    <div class="br txt-c" style="width:20px;">No</div>
                    <div class="txt-c" style="flex:0 0 70px;">Fouls</div>
                </div>
                ${st[tk].players.map(p=>getP(p)).join('')}
                <div class="s-row bb" style="height:5mm; font-size:8px; padding-left:2px;"><strong>Coach:</strong> ${st[tk].coach}</div>
                <div class="s-row" style="height:5mm; font-size:8px; padding-left:2px;"><strong>A.Coach:</strong> ${st[tk].ac}</div>
            </div>
        </div>`;

    // Player Number Cell in Running Score
    const getRunNum = (d) => {
        if(!d) return '<div style="flex:1;"></div>';
        const isRed = (d.q===1 || d.q===3);
        const colClass = isRed ? 'text-red' : '';
        let content = d.no;
        if(d.type===3) content = `<div class="${isRed?'circle-num-red':'circle-num'}">${d.no}</div>`;
        return `<div class="txt-c txt-b ${colClass}" style="flex:1;">${content}</div>`;
    }

    const getRun = (s,e) => `
        <div class="br" style="flex:1; display:flex; flex-direction:column;">
            <div class="s-row bb bg-g txt-b txt-c" style="font-size:8px; height:5mm; align-items:center;">
                <div style="flex:1;">A</div><div style="flex:1;">S</div><div style="flex:1;">B</div>
            </div>
            <div style="flex:1; display:flex; flex-direction:column;">
                ${run.slice(s,e).map(r=> {
                    // Symbol logic
                    const isRedA = r.a && (r.a.q===1 || r.a.q===3);
                    const isRedB = r.b && (r.b.q===1 || r.b.q===3);
                    
                    let symA = r.sc;
                    let symB = r.sc;
                    
                    if(r.a) {
                        if(r.a.type===1) symA = `<div class="${isRedA?'filled-dot-red':'filled-dot'}"></div>`;
                        else if(r.a.type===2 || r.a.type===3) symA = `<div class="${isRedA?'slash-red':'slash'}" style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;">${r.sc}</div>`;
                    }
                    if(r.b) {
                        if(r.b.type===1) symB = `<div class="${isRedB?'filled-dot-red':'filled-dot'}"></div>`;
                        else if(r.b.type===2 || r.b.type===3) symB = `<div class="${isRedB?'slash-red':'slash'}" style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;">${r.sc}</div>`;
                    }
                    
                    return `
                    <div class="s-row" style="height:2.5%; border-bottom:1px solid ${r.sc%5===0?'#000':'#ccc'}; align-items:center; font-size:8px;">
                        ${getRunNum(r.a)}
                        <div class="txt-c" style="flex:1; ${r.a?'font-weight:bold;':(r.b?'':'color:#ccc; font-size:6px;')}">${symA}</div>
                        <div class="txt-c" style="flex:1; ${r.b?'font-weight:bold;':(r.a?'':'color:#ccc; font-size:6px;')}">${symB}</div>
                        ${getRunNum(r.b)}
                    </div>`;
                }).join('')}
            </div>
        </div>`;

    document.getElementById('sheet-paper').innerHTML = `
        <div style="height:30mm; position:relative; border-bottom:2px solid #000; margin-bottom:2mm;">
            <div class="txt-c txt-b" style="font-size:14pt; letter-spacing:2px; position:absolute; width:100%; top:8mm;">OFFICIAL SCORESHEET</div>
            <div style="display:flex; justify-content:space-between; align-items:end; height:100%; padding-bottom:2px; font-size:9px;">
                <div style="width:30%;">
                    <div><strong>Tm A:</strong> ${st.teamA.name}</div>
                    <div><strong>Comp:</strong> ${st.meta.competition}</div>
                    <div><strong>No:</strong> ${st.meta.no}</div>
                </div>
                <div style="width:30%; text-align:center;">
                    <div>${st.meta.date} ${st.meta.time}</div>
                    <div>${st.meta.place}</div>
                </div>
                <div style="width:30%;">
                    <div><strong>Tm B:</strong> ${st.teamB.name}</div>
                    <div class="bd" style="padding:2px;">
                        <div><strong>CC:</strong> ${st.meta.crewChief}</div>
                        <div style="display:flex; justify-content:space-between;">
                            <span><strong>U1:</strong> ${st.meta.umpire1}</span>
                            <span><strong>U2:</strong> ${st.meta.umpire2}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div style="flex:1; display:flex; gap:3mm; overflow:hidden;">
            <div style="width:50%; display:flex; flex-direction:column;">
                ${getTm('teamA','Team A')}
                ${getTm('teamB','Team B')}
                <div class="bd" style="margin-top:auto; font-size:9px; border-width:2px;">
                    <div class="s-row bb bg-g txt-b txt-c"><div style="flex:2;" class="br">SCORES</div><div class="br" style="flex:1;">1Q</div><div class="br" style="flex:1;">2Q</div><div class="br" style="flex:1;">3Q</div><div style="flex:1;">4Q</div></div>
                    <div class="s-row bb txt-c"><div style="flex:2;" class="br txt-b">A</div><div class="br" style="flex:1;">${sumA[1]}</div><div class="br" style="flex:1;">${sumA[2]}</div><div class="br" style="flex:1;">${sumA[3]}</div><div style="flex:1;">${sumA[4]}</div></div>
                    <div class="s-row bb txt-c"><div style="flex:2;" class="br txt-b">B</div><div class="br" style="flex:1;">${sumB[1]}</div><div class="br" style="flex:1;">${sumB[2]}</div><div class="br" style="flex:1;">${sumB[3]}</div><div style="flex:1;">${sumB[4]}</div></div>
                    <div class="s-row bb bg-g" style="padding:2px; justify-content:space-around;"><strong>Final</strong> <span>A: ${cA}</span> <span>B: ${cB}</span></div>
                    <div class="s-row" style="padding:2px;"><strong>Winner:</strong> ${cA>cB?st.teamA.name:(cB>cA?st.teamB.name:'')}</div>
                </div>
            </div>
            <div style="width:50%; border:2px solid #000; display:flex; flex-direction:column;">
                <div class="bb bg-g txt-c txt-b" style="padding:2px; letter-spacing:2px; font-size:10px;">RUNNING SCORE</div>
                <div style="flex:1; display:flex;">
                    ${getRun(0,40)} ${getRun(40,80)} ${getRun(80,120)} ${getRun(120,160).replace('border-right:1px solid #000;','border:none;')}
                </div>
            </div>
        </div>
        <div class="bd" style="margin-top:2mm; padding:2px; display:flex; gap:10px; font-size:8px;">
            <div style="flex:1;"><strong>Scorer:</strong> ${st.meta.scorer}</div>
            <div style="flex:1;"><strong>Timer:</strong> ${st.meta.timer}</div>
            <div style="flex:1;"><strong>ShotClock:</strong> ${st.meta.shotClock}</div>
        </div>
    `;
}

function fitSheet() {
    const v = document.getElementById('sheet-view');
    const p = document.getElementById('sheet-paper');
    if(!v || !p) return;
    p.style.transform = 'none';
    const s = Math.min((v.clientWidth-40)/p.offsetWidth, (v.clientHeight-40)/p.offsetHeight);
    if(s<1) {
        p.style.transformOrigin = 'top center';
        p.style.transform = `scale(${s})`;
        p.style.marginBottom = `-${p.offsetHeight*(1-s)}px`;
    }
}

// Init
renInput();
</script>
</body>
</html>

