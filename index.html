<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Official Basketball Score Sheet (Offline)</title>
<style>
    /* --- CSS Reset & Base --- */
    * { box-sizing: border-box; }
    body { 
        margin: 0; padding: 0; 
        font-family: "Times New Roman", "YuMincho", "Hiragino Mincho ProN", "Yu Mincho", "MS PMincho", serif;
        background-color: #525659; /* Reader background color */
        color: #000;
        -webkit-font-smoothing: antialiased;
    }
    
    /* --- UI Specific Fonts (Sans-Serif) --- */
    .ui-font { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }

    /* --- Screen Layout --- */
    #app { display: flex; flex-direction: column; height: 100vh; }
    
    /* --- Navbar --- */
    nav { 
        background-color: #1a1a1a; color: white; padding: 0.5rem 1rem; 
        display: flex; justify-content: space-between; align-items: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        z-index: 100;
    }
    .btn { 
        padding: 0.5rem 1rem; border-radius: 4px; border: none; cursor: pointer; 
        font-size: 0.875rem; font-weight: bold; transition: background 0.2s;
        display: inline-flex; align-items: center; gap: 0.5rem;
    }
    .btn-primary { background-color: #2563eb; color: white; }
    .btn-primary:hover { background-color: #1d4ed8; }
    .btn-secondary { background-color: #4b5563; color: white; }
    .btn-secondary:hover { background-color: #374151; }
    .btn-success { background-color: #16a34a; color: white; }
    .btn-warning { background-color: #ca8a04; color: white; }
    .btn-danger { background-color: #dc2626; color: white; }
    
    .nav-group { display: flex; gap: 0.5rem; background: #333; padding: 0.25rem; border-radius: 4px; }
    .nav-btn { background: transparent; color: #9ca3af; }
    .nav-btn.active { background: white; color: #111827; shadow: 0 1px 2px rgba(0,0,0,0.1); }

    /* --- Input View --- */
    .input-container { display: flex; flex: 1; overflow: hidden; background: #f3f4f6; }
    .scoreboard { background: #111827; color: white; padding: 1rem; display: flex; justify-content: space-between; align-items: center; }
    .team-card { flex: 1; padding: 0.5rem; border-radius: 8px; text-align: center; cursor: pointer; border: 2px solid transparent; transition: all 0.2s; }
    .team-card.active { background: #1f2937; border-color: #3b82f6; }
    .score-display { font-size: 3rem; font-family: monospace; font-weight: bold; color: #facc15; line-height: 1; }
    .player-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 0.5rem; padding: 0.5rem; overflow-y: auto; }
    .player-btn { 
        background: white; border: 1px solid #e5e7eb; padding: 0.75rem; border-radius: 8px; 
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        transition: all 0.1s; position: relative; min-height: 80px;
    }
    .player-btn.active { background: #2563eb; color: white; border-color: #2563eb; transform: scale(1.05); z-index: 10; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .player-btn.fouled-out { opacity: 0.5; background: #fee2e2; }
    .foul-dots { display: flex; gap: 2px; margin-top: 4px; }
    .dot { width: 6px; height: 6px; border-radius: 50%; background: #e5e7eb; }
    .dot.active { background: #eab308; }
    .dot.active-selected { background: #fde047; }

    .controls { width: 300px; background: white; border-left: 1px solid #e5e7eb; padding: 1rem; display: flex; flex-direction: column; gap: 1rem; overflow-y: auto; }
    .action-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem; }
    .action-btn { padding: 1rem 0; border-radius: 8px; font-weight: bold; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    .big-num { font-size: 1.5rem; line-height: 1; }
    .sub-text { font-size: 0.75rem; font-weight: normal; }

    /* --- Settings View --- */
    .settings-container { max-width: 900px; margin: 2rem auto; background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); overflow-y: auto; height: calc(100vh - 100px); }
    .form-group { margin-bottom: 1rem; }
    .form-label { display: block; font-size: 0.875rem; font-weight: bold; color: #374151; margin-bottom: 0.25rem; }
    .form-input { width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 1rem; }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    .table-input { width: 100%; border: none; background: transparent; text-align: center; padding: 4px; }
    .table-input:focus { background: #eff6ff; outline: 1px solid #3b82f6; }

    /* --- SHEET CSS (Official Layout) --- */
    .sheet-wrapper {
        width: 100%;
        height: calc(100vh - 60px);
        overflow: auto;
        display: flex;
        justify-content: center;
        background: #525659;
        padding: 20px;
    }

    .sheet {
        width: 210mm;
        height: 297mm;
        background: white;
        padding: 10mm;
        box-shadow: 0 0 10px rgba(0,0,0,0.5);
        position: relative;
        box-sizing: border-box;
        font-size: 10px; /* Base font size for sheet */
        display: flex;
        flex-direction: column;
    }
    
    .sheet-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
        border-bottom: 2px solid black;
        padding-bottom: 5px;
        margin-bottom: 5px;
    }
    
    .sheet-title {
        text-align: center;
        font-weight: bold;
        font-size: 16px;
        letter-spacing: 2px;
        position: absolute;
        width: 100%;
        top: 15mm;
        left: 0;
        pointer-events: none; /* Let clicks pass through */
    }

    .header-info-box {
        display: flex;
        flex-direction: column;
        gap: 2px;
        width: 30%;
    }

    .info-row { display: flex; align-items: flex-end; gap: 4px; white-space: nowrap; }
    .info-label { font-weight: bold; font-size: 9px; }
    .info-val { border-bottom: 1px solid #000; flex: 1; text-align: center; height: 14px; }
    
    .referee-box {
        border: 1px solid black;
        display: flex;
        justify-content: space-between;
        padding: 2px 5px;
        margin-bottom: 5px;
        font-size: 9px;
    }

    /* Main Content Area */
    .sheet-body {
        display: flex;
        flex: 1;
        gap: 4mm;
    }

    /* Left Column (Teams) */
    .col-left {
        width: 50%;
        display: flex;
        flex-direction: column;
    }

    /* Team Section */
    .team-section { margin-bottom: 5px; }
    .team-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
        border-bottom: 1px solid black;
        margin-bottom: 2px;
    }
    .team-name { font-size: 14px; font-weight: bold; text-transform: uppercase; }
    
    .team-meta {
        display: flex;
        justify-content: space-between;
        margin-bottom: 2px;
        font-size: 9px;
    }
    .timeout-grid { display: flex; gap: 2px; }
    .timeout-box { width: 16px; height: 14px; border: 1px solid black; text-align: center; line-height: 12px; font-weight: bold; }
    
    .foul-grid { display: flex; gap: 2px; align-items: center; }
    .foul-box { width: 16px; height: 14px; border: 1px solid black; text-align: center; line-height: 12px; }

    /* Player Table */
    .player-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 9px;
        table-layout: fixed;
    }
    .player-table th, .player-table td {
        border: 1px solid #000; /* Standard thin border */
        padding: 1px 2px;
        height: 15px; /* Fixed height for rows */
    }
    .player-table th { background: #f0f0f0; text-align: center; font-weight: bold; height: 20px; }
    
    .col-lic { width: 25px; text-align: center; }
    .col-no { width: 25px; text-align: center; font-family: sans-serif; font-weight: bold; }
    .col-name { text-align: left; overflow: hidden; white-space: nowrap; }
    .col-foul { width: 14px; text-align: center; border-right: none; }
    .col-foul-last { border-right: 1px solid black; }

    /* Score Summary Table */
    .score-summary {
        margin-top: auto; /* Push to bottom of left col */
        border: 2px solid black;
        width: 100%;
        font-size: 9px;
    }
    .summary-row { display: flex; border-bottom: 1px solid black; height: 18px; }
    .summary-row:last-child { border-bottom: none; }
    .summary-header { background: #f0f0f0; font-weight: bold; }
    .s-cell { flex: 1; border-right: 1px solid black; display: flex; align-items: center; justify-content: center; }
    .s-cell:last-child { border-right: none; }
    .s-wide { flex: 2; }

    /* Right Column (Running Score) */
    .col-right {
        width: 50%;
        border: 2px solid black;
        display: flex;
        flex-direction: column;
    }
    .running-header {
        text-align: center;
        font-weight: bold;
        background: #f0f0f0;
        border-bottom: 1px solid black;
        padding: 2px;
        letter-spacing: 3px;
    }
    .running-body {
        display: flex;
        flex: 1;
    }
    .running-col {
        flex: 1;
        display: flex;
        flex-direction: column;
        border-right: 1px solid black;
    }
    .running-col:last-child { border-right: none; }
    
    .rc-header {
        display: flex;
        height: 20px;
        border-bottom: 1px solid black;
        background: #f0f0f0;
        font-weight: bold;
        align-items: center;
    }
    .rc-cell { flex: 1; text-align: center; font-size: 8px; }
    
    .rc-row {
        display: flex;
        height: 14.5px; /* Adjusted to fit 40 rows */
        border-bottom: 1px solid #ccc;
        align-items: center;
    }
    .rc-row:nth-child(5n) { border-bottom: 1px solid #888; } /* Guide line every 5 */
    
    .rc-num { flex: 1; text-align: center; font-weight: bold; font-family: sans-serif; font-size: 9px; }
    .rc-score { flex: 1; text-align: center; font-size: 8px; color: #888; }
    .rc-score.filled { color: black; font-weight: bold; font-size: 10px; }
    
    /* Footer */
    .sheet-footer {
        margin-top: 5px;
        border: 1px solid black;
        padding: 2px 5px;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        font-size: 9px;
    }
    .footer-item { display: flex; align-items: flex-end; gap: 5px; width: 30%; }

    /* --- Utilities --- */
    .hidden { display: none !important; }
    .text-center { text-align: center; }
    .font-bold { font-weight: bold; }
    .border-b { border-bottom: 1px solid black; }
    
    /* --- Print Media Query --- */
    @media print {
        @page { size: A4 portrait; margin: 0; }
        body { background: white; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        nav, .input-container, .settings-container { display: none !important; }
        
        .sheet-wrapper {
            display: block;
            width: 100%;
            height: auto;
            overflow: visible;
            padding: 0;
            margin: 0;
            background: white;
        }
        
        .sheet {
            box-shadow: none;
            margin: 0;
            page-break-after: always;
            width: 100%;
            height: 100vh; /* Force full height */
            padding: 8mm 10mm; /* Adjusted padding for printer margins */
        }

        /* Ensure borders print */
        * { border-color: black !important; }
    }
</style>
</head>
<body>

<div id="app">
    <!-- Navbar injected by JS -->
</div>

<script>
/**
 * --- Application State ---
 * バニラJSによる状態管理
 */

// データ構造の初期化
const createPlayer = (team, i) => ({ 
    id: `${team}-${i}`, 
    number: '', 
    license: '', // 追加: PDFにあるLicense No.
    name: '', 
    isCaptain: false, 
    fouls: [], 
    points: 0 
});

const initialState = {
    view: 'input', // input, sheet, settings
    teamA: {
        name: 'Team A', color: '', coach: '', assistantCoach: '',
        players: Array.from({length: 18}, (_, i) => createPlayer('A', i+1)),
        timeouts: { 1: [], 2: [] }, // 1=前半(1-2Q), 2=後半(3-4Q)
        fouls: { 1:0, 2:0, 3:0, 4:0 }
    },
    teamB: {
        name: 'Team B', color: '', coach: '', assistantCoach: '',
        players: Array.from({length: 18}, (_, i) => createPlayer('B', i+1)),
        timeouts: { 1: [], 2: [] },
        fouls: { 1:0, 2:0, 3:0, 4:0 }
    },
    game: {
        competition: '令和__年度 京都府高等学校総合体育大会',
        no: '',
        date: new Date().toISOString().slice(0, 10),
        time: '10:00',
        place: '',
        crewChief: '', umpire1: '', umpire2: '',
        scorer: '', assistantScorer: '', timer: '', shotClock: '',
        endTime: ''
    },
    quarter: 1,
    scores: [], // { q: 1, team: 'A', playerNo: '4', val: 2, runningA: 2, runningB: 0 }
    history: [],
    selectedTeam: 'A',
    selectedPlayerId: null
};

// State Container
let state = JSON.parse(JSON.stringify(initialState));

// --- Logic Functions ---

function saveState() {
    localStorage.setItem('basket_score_offline_v2', JSON.stringify(state));
    alert('保存しました (Saved to Browser)');
}

function loadState() {
    const saved = localStorage.getItem('basket_score_offline_v2');
    if(saved) {
        try {
            const parsed = JSON.parse(saved);
            // マージロジックがあれば良いが、今回は単純置換
            state = parsed;
            render();
        } catch(e) { console.error(e); }
    }
}

function update(path, value) {
    // path: 'teamA.name', 'game.place', 'teamA.players.0.number'
    const parts = path.split('.');
    let target = state;
    for(let i=0; i<parts.length-1; i++) {
        target = target[parts[i]];
    }
    target[parts[parts.length-1]] = value;
    // 画面全体再描画は重いので、設定画面ではonchangeでのみデータ更新し、
    // 必要な時だけ再描画するが、今回はシンプルに都度renderする
    // ただし入力のフォーカス外れを防ぐため、SettingsViewは慎重に実装
}

function addScore(val) {
    if(!state.selectedPlayerId) return alert('選手を選択してください');
    
    const teamKey = state.selectedTeam === 'A' ? 'teamA' : 'teamB';
    const player = state[teamKey].players.find(p => p.id === state.selectedPlayerId);
    
    if(!player.number) return alert('選手の背番号が設定されていません');

    // History push
    state.history.push(JSON.stringify({scores: state.scores, players: [state.teamA.players, state.teamB.players]})); // 簡易保存

    // Calculate current running score
    const totalA = calcScore('A');
    const totalB = calcScore('B');
    
    const newScore = {
        q: state.quarter,
        team: state.selectedTeam,
        playerNo: player.number,
        val: val,
        runningA: state.selectedTeam === 'A' ? totalA + val : totalA,
        runningB: state.selectedTeam === 'B' ? totalB + val : totalB
    };
    
    state.scores.push(newScore);
    player.points += val;
    render();
}

function addFoul(type) {
    if(!state.selectedPlayerId) return alert('選手を選択してください');
    const teamKey = state.selectedTeam === 'A' ? 'teamA' : 'teamB';
    const player = state[teamKey].players.find(p => p.id === state.selectedPlayerId);
    
    if(player.fouls.length >= 5) return alert('退場(5ファウル)済みです');
    
    player.fouls.push(type);
    
    // Team Foul加算 (4Q以降は延長も含むが今回は簡易的に4に加算)
    const qKey = state.quarter > 4 ? 4 : state.quarter;
    state[teamKey].fouls[qKey]++;
    
    render();
}

function addTimeout(team) {
    const teamKey = team === 'A' ? 'teamA' : 'teamB';
    const half = state.quarter <= 2 ? 1 : 2;
    const limit = half === 1 ? 2 : 3;
    
    if(state[teamKey].timeouts[half].length >= limit) return alert('前半/後半の制限数を超えています');
    
    // 時間を記録するが、シートには分数(残り時間)を書くことが多い。今回は'X'や分数を入力させる代わりに自動カウント
    // 実際の運用では分数を手書きすることが多いので、ここでは単純なマークとして扱う
    const timeStr = prompt("タイムアウト時間（分）を入力、または空欄", state.game.time);
    state[teamKey].timeouts[half].push(timeStr || 'X');
    render();
}

function undo() {
    if(state.scores.length === 0) return;
    state.scores.pop();
    // プレイヤーのポイント再計算が必要だが、今回は簡易実装のため省略せず、scoresから全再計算すべき
    // リセットして再計算
    ['teamA', 'teamB'].forEach(tk => {
        state[tk].players.forEach(p => p.points = 0);
    });
    state.scores.forEach(s => {
        const p = state[`team${s.team}`].players.find(pl => pl.number === s.playerNo);
        if(p) p.points += s.val;
    });
    render();
}

function calcScore(team) {
    return state.scores.filter(s => s.team === team).reduce((a,c) => a + c.val, 0);
}

function calcQuarterScore(team, q) {
    return state.scores.filter(s => s.team === team && s.q === q).reduce((a,c) => a + c.val, 0);
}

// --- View Components (String Templates) ---

const Icons = {
    Pen: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>`,
    Sheet: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>`,
    Settings: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>`,
    Print: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>`,
};

const Navbar = () => `
    <nav class="ui-font">
        <div style="font-weight:bold; font-size:1.2rem;">BasketScore Offline</div>
        <div class="nav-group">
            <button class="btn nav-btn ${state.view==='input'?'active':''}" onclick="state.view='input'; render()">${Icons.Pen} 入力</button>
            <button class="btn nav-btn ${state.view==='sheet'?'active':''}" onclick="state.view='sheet'; render()">${Icons.Sheet} シート</button>
            <button class="btn nav-btn ${state.view==='settings'?'active':''}" onclick="state.view='settings'; render()">${Icons.Settings} 設定</button>
        </div>
        <div>
            ${state.view === 'sheet' ? `<button class="btn btn-warning" onclick="window.print()">${Icons.Print} 印刷</button>` : ''}
            <button class="btn btn-primary" onclick="saveState()">保存</button>
        </div>
    </nav>
`;

const InputView = () => {
    const activeTeam = state.selectedTeam === 'A' ? state.teamA : state.teamB;
    const players = activeTeam.players.filter(p => p.number); // 番号がある選手のみ表示
    
    return `
    <div class="input-container ui-font">
        <div style="display:flex; flex-direction:column; flex:1;">
            <div class="scoreboard">
                <div class="team-card ${state.selectedTeam==='A'?'active':''}" onclick="state.selectedTeam='A'; state.selectedPlayerId=null; render()">
                    <div style="font-size:0.8rem; color:#9ca3af;">${state.teamA.name}</div>
                    <div class="score-display">${calcScore('A')}</div>
                    <div style="font-size:0.8rem;">Fouls: ${state.teamA.fouls[state.quarter]||0}</div>
                </div>
                <div style="text-align:center;">
                    <div style="color:#ef4444; font-weight:bold; font-size:1.5rem;">Q${state.quarter}</div>
                    <button class="btn btn-secondary" style="padding:2px 8px; font-size:0.7rem;" onclick="state.quarter++; render()">Next Q</button>
                </div>
                <div class="team-card ${state.selectedTeam==='B'?'active':''}" onclick="state.selectedTeam='B'; state.selectedPlayerId=null; render()">
                    <div style="font-size:0.8rem; color:#9ca3af;">${state.teamB.name}</div>
                    <div class="score-display">${calcScore('B')}</div>
                    <div style="font-size:0.8rem;">Fouls: ${state.teamB.fouls[state.quarter]||0}</div>
                </div>
            </div>
            
            <div class="player-grid">
                ${players.length === 0 ? '<div style="grid-column:1/-1; text-align:center; padding:2rem; color:#666;">選手が登録されていません。<br>設定タブで選手情報を入力してください。</div>' : ''}
                ${players.map(p => `
                    <button class="player-btn ${state.selectedPlayerId===p.id?'active':''} ${p.fouls.length>=5?'fouled-out':''}" 
                        onclick="state.selectedPlayerId='${p.id}'; render()">
                        ${p.isCaptain ? '<div style="position:absolute; top:2px; left:4px; font-size:0.7rem; font-weight:bold; color:#eab308;">CAP</div>' : ''}
                        <div style="font-size:1.5rem; font-family:monospace; font-weight:bold;">${p.number}</div>
                        <div style="font-size:0.8rem; width:100%; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; text-align:center;">${p.name}</div>
                        <div class="foul-dots">
                            ${[1,2,3,4,5].map(i => `<div class="dot ${i<=p.fouls.length ? (state.selectedPlayerId===p.id?'active-selected':'active') : ''}"></div>`).join('')}
                        </div>
                    </button>
                `).join('')}
            </div>
        </div>

        <div class="controls">
            <div style="text-align:center; padding-bottom:1rem; border-bottom:1px solid #eee;">
                <div style="font-size:0.8rem; color:#666;">選択中</div>
                <div style="font-weight:bold; font-size:1.2rem; height:1.5rem;">
                    ${(() => {
                        if(!state.selectedPlayerId) return '未選択';
                        const p = activeTeam.players.find(x => x.id === state.selectedPlayerId);
                        return `#${p.number} ${p.name}`;
                    })()}
                </div>
            </div>
            
            <div style="font-weight:bold; color:#374151;">得点</div>
            <div class="action-grid">
                <button class="btn btn-success action-btn" onclick="addScore(1)">
                    <span class="big-num">+1</span>
                    <span class="sub-text">FT</span>
                </button>
                <button class="btn btn-success action-btn" onclick="addScore(2)">
                    <span class="big-num">+2</span>
                    <span class="sub-text">FG</span>
                </button>
                <button class="btn btn-success action-btn" onclick="addScore(3)">
                    <span class="big-num">+3</span>
                    <span class="sub-text">3P</span>
                </button>
            </div>

            <div style="font-weight:bold; color:#374151; margin-top:1rem;">ファウル</div>
            <div class="action-grid">
                <button class="btn btn-warning action-btn" onclick="addFoul('P')">P</button>
                <button class="btn btn-warning action-btn" onclick="addFoul('P1')">P1</button>
                <button class="btn btn-warning action-btn" onclick="addFoul('P2')">P2</button>
            </div>

            <div style="margin-top:auto;">
                <div class="grid-2">
                    <button class="btn btn-secondary" onclick="addTimeout('A')">A タイムアウト</button>
                    <button class="btn btn-secondary" onclick="addTimeout('B')">B タイムアウト</button>
                </div>
                <button class="btn btn-danger" style="width:100%; margin-top:1rem;" onclick="undo()">取り消し (Undo)</button>
            </div>
        </div>
    </div>
    `;
};

const SettingsView = () => {
    // 描画コスト削減のため、inputのonchangeでstateを更新するが、
    // ここではHTML文字列を再生成する方式をとる（シンプルさ優先）。
    // 実際のアプリでは仮想DOMなどを使うべきだが、バニラJSなのでこれで行く。
    
    const renderTeamSettings = (teamKey, label) => `
        <div style="margin-bottom:2rem;">
            <h3 style="border-bottom:2px solid #ddd; padding-bottom:0.5rem; margin-bottom:1rem;">${label} 設定</h3>
            <div class="grid-2">
                <div class="form-group">
                    <label class="form-label">チーム名</label>
                    <input class="form-input" value="${state[teamKey].name}" onchange="update('${teamKey}.name', this.value)">
                </div>
                <div class="form-group">
                    <label class="form-label">ユニフォーム色</label>
                    <input class="form-input" value="${state[teamKey].color}" onchange="update('${teamKey}.color', this.value)">
                </div>
            </div>
            <div class="grid-2">
                <div class="form-group">
                    <label class="form-label">コーチ</label>
                    <input class="form-input" value="${state[teamKey].coach}" onchange="update('${teamKey}.coach', this.value)">
                </div>
                <div class="form-group">
                    <label class="form-label">A.コーチ</label>
                    <input class="form-input" value="${state[teamKey].assistantCoach}" onchange="update('${teamKey}.assistantCoach', this.value)">
                </div>
            </div>

            <table style="width:100%; border-collapse:collapse; margin-top:1rem;">
                <thead style="background:#f3f4f6; font-size:0.8rem;">
                    <tr><th style="padding:4px;">No.</th><th style="padding:4px;">Lic No.</th><th>選手名</th><th style="width:50px;">CAP</th></tr>
                </thead>
                <tbody>
                    ${state[teamKey].players.map((p, i) => `
                        <tr style="border-bottom:1px solid #eee;">
                            <td style="width:60px;"><input class="table-input" value="${p.number}" placeholder="No" onchange="update('${teamKey}.players.${i}.number', this.value)"></td>
                            <td style="width:80px;"><input class="table-input" value="${p.license}" placeholder="Lic" onchange="update('${teamKey}.players.${i}.license', this.value)"></td>
                            <td><input class="table-input" style="text-align:left;" value="${p.name}" placeholder="氏名" onchange="update('${teamKey}.players.${i}.name', this.value)"></td>
                            <td style="text-align:center;"><input type="checkbox" ${p.isCaptain?'checked':''} onchange="update('${teamKey}.players.${i}.isCaptain', this.checked)"></td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;

    return `
    <div class="ui-font" style="background:#f3f4f6; height:100%; overflow:hidden;">
        <div class="settings-container">
            <h2 style="margin-top:0;">試合設定</h2>
            <div class="form-group">
                <label class="form-label">大会名</label>
                <input class="form-input" value="${state.game.competition}" onchange="update('game.competition', this.value)">
            </div>
            <div class="grid-2">
                <div class="form-group"><label class="form-label">Game No.</label><input class="form-input" value="${state.game.no}" onchange="update('game.no', this.value)"></div>
                <div class="form-group"><label class="form-label">会場</label><input class="form-input" value="${state.game.place}" onchange="update('game.place', this.value)"></div>
            </div>
            <div class="grid-2">
                <div class="form-group"><label class="form-label">日付</label><input type="date" class="form-input" value="${state.game.date}" onchange="update('game.date', this.value)"></div>
                <div class="form-group"><label class="form-label">時間</label><input type="time" class="form-input" value="${state.game.time}" onchange="update('game.time', this.value)"></div>
            </div>
            
            <div style="margin: 2rem 0; border-top:1px solid #ddd;"></div>

            ${renderTeamSettings('teamA', 'チームA')}
            ${renderTeamSettings('teamB', 'チームB')}

            <div style="margin: 2rem 0; border-top:1px solid #ddd;"></div>

            <h3>審判・オフィシャル</h3>
            <div class="grid-2">
                <div class="form-group"><label class="form-label">クルーチーフ</label><input class="form-input" value="${state.game.crewChief}" onchange="update('game.crewChief', this.value)"></div>
                <div class="form-group"><label class="form-label">1st アンパイア</label><input class="form-input" value="${state.game.umpire1}" onchange="update('game.umpire1', this.value)"></div>
                <div class="form-group"><label class="form-label">2nd アンパイア</label><input class="form-input" value="${state.game.umpire2}" onchange="update('game.umpire2', this.value)"></div>
            </div>
            <div class="grid-2">
                <div class="form-group"><label class="form-label">スコアラー</label><input class="form-input" value="${state.game.scorer}" onchange="update('game.scorer', this.value)"></div>
                <div class="form-group"><label class="form-label">A.スコアラー</label><input class="form-input" value="${state.game.assistantScorer}" onchange="update('game.assistantScorer', this.value)"></div>
                <div class="form-group"><label class="form-label">タイマー</label><input class="form-input" value="${state.game.timer}" onchange="update('game.timer', this.value)"></div>
                <div class="form-group"><label class="form-label">ショットクロック</label><input class="form-input" value="${state.game.shotClock}" onchange="update('game.shotClock', this.value)"></div>
            </div>
        </div>
    </div>
    `;
};

// --- Sheet Rendering Logic ---

const SheetView = () => {
    // ランニングスコアデータの構築
    const runningData = [];
    let curA = 0, curB = 0;
    // 160点分確保
    for(let i=1; i<=160; i++) runningData.push({ score: i, a: null, b: null });
    
    state.scores.forEach(s => {
        // 現在の累積スコア
        const isA = s.team === 'A';
        const start = isA ? curA : curB;
        const end = start + s.val;
        
        // 得点線の描画データ (斜線などをCSSで表現するのは難しいので、得点が入った行に番号を入れる方式)
        // PDFの仕様に合わせる:
        // Aチームが得点したら、A列に番号、A得点列に累積スコア。
        // 同じ行のB側は空欄。
        if(isA) {
            // end点目の行のA側にデータをセット
            if(runningData[end-1]) {
                runningData[end-1].a = { no: s.playerNo, q: s.q };
            }
            curA = end;
        } else {
            if(runningData[end-1]) {
                runningData[end-1].b = { no: s.playerNo, q: s.q };
            }
            curB = end;
        }
    });

    const renderTeam = (tk) => {
        const team = state[tk];
        // 選手は18人分枠を確保
        const rows = [];
        for(let i=0; i<18; i++) {
            const p = team.players[i] || { number:'', license:'', name:'', fouls:[] };
            rows.push(p);
        }

        return `
        <div class="team-section">
            <div class="team-header">
                <div style="font-size:9px;">チーム${tk === 'teamA' ? 'A' : 'B'}</div>
                <div class="team-name">${team.name}</div>
                <div style="font-size:9px; margin-left:auto;">Color: ${team.color}</div>
            </div>
            
            <div class="team-meta">
                <div style="width:45%;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:2px;">
                        <strong>タイムアウト</strong>
                        <div class="timeout-grid">
                            ${[0,1].map(i => `<div class="timeout-box">${team.timeouts[1][i]||''}</div>`).join('')}
                            <span style="font-size:8px; line-height:14px;">(1·2)</span>
                            ${[0,1,2].map(i => `<div class="timeout-box">${team.timeouts[2][i]||''}</div>`).join('')}
                            <span style="font-size:8px; line-height:14px;">(3·4)</span>
                        </div>
                    </div>
                </div>
                <div style="width:50%;">
                    <div style="display:flex; justify-content:space-between;">
                        <strong>チームファウル</strong>
                        <div style="display:flex; gap:4px;">
                            ${[1,2,3,4].map(q => `
                                <div style="display:flex; align-items:center; gap:2px;">
                                    <span style="font-size:8px;">${q}</span>
                                    <div class="foul-box">${team.fouls[q]>0 ? (team.fouls[q]>4?5:team.fouls[q]) : ''}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            </div>

            <table class="player-table">
                <thead>
                    <tr>
                        <th class="col-lic">Lic.</th>
                        <th class="col-no">No.</th>
                        <th class="col-name">選手氏名</th>
                        <th class="col-no">No.</th>
                        <th colspan="5">ファウル</th>
                    </tr>
                </thead>
                <tbody>
                    ${rows.map((p, i) => `
                        <tr>
                            <td class="col-lic">${p.license}</td>
                            <td class="col-no" style="font-size:8px; color:#888;">${i+1}</td>
                            <td class="col-name">${p.name} ${p.isCaptain?'(CAP)':''}</td>
                            <td class="col-no">${p.number}</td>
                            <td class="col-foul">${p.fouls[0]||''}</td>
                            <td class="col-foul">${p.fouls[1]||''}</td>
                            <td class="col-foul">${p.fouls[2]||''}</td>
                            <td class="col-foul">${p.fouls[3]||''}</td>
                            <td class="col-foul col-foul-last">${p.fouls[4]||''}</td>
                        </tr>
                    `).join('')}
                    <tr>
                        <td colspan="4" style="text-align:left; border-right:none;"><span style="font-weight:bold;">コーチ:</span> ${team.coach}</td>
                        <td colspan="5" style="border-left:none;"></td>
                    </tr>
                    <tr>
                        <td colspan="4" style="text-align:left; border-right:none;"><span style="font-weight:bold;">A.コーチ:</span> ${team.assistantCoach}</td>
                        <td colspan="5" style="border-left:none;"></td>
                    </tr>
                </tbody>
            </table>
        </div>
        `;
    };

    const renderRunningColumn = (startIdx, endIdx) => {
        // 40行分
        const slice = runningData.slice(startIdx, endIdx);
        return `
        <div class="running-col">
            <div class="rc-header">
                <div class="rc-cell">A</div>
                <div class="rc-cell">Score</div>
                <div class="rc-cell">B</div>
            </div>
            ${slice.map(row => `
                <div class="rc-row">
                    <div class="rc-num" style="${row.a && (row.a.q===1||row.a.q===3)?'color:red;':''}">${row.a ? row.a.no : ''}</div>
                    <div class="rc-score ${row.a?'filled':''}" style="${row.a && (row.a.q===1||row.a.q===3)?'color:red;':''}">${row.score}</div>
                    <div class="rc-score ${row.b?'filled':''}" style="${row.b && (row.b.q===1||row.b.q===3)?'color:red;':''}">${row.score}</div>
                    <div class="rc-num" style="${row.b && (row.b.q===1||row.b.q===3)?'color:red;':''}">${row.b ? row.b.no : ''}</div>
                </div>
            `).join('')}
        </div>
        `;
    };

    return `
    <div class="sheet-wrapper">
        <div class="sheet">
            <div class="sheet-title">OFFICIAL SCORESHEET</div>
            
            <div class="sheet-header">
                <div class="header-info-box">
                    <div class="info-row"><span class="info-label">チームA:</span><div class="info-val">${state.teamA.name}</div></div>
                    <div class="info-row"><span class="info-label">大会名:</span><div class="info-val">${state.game.competition}</div></div>
                    <div class="info-row"><span class="info-label">Game No:</span><div class="info-val" style="width:30px; flex:none;">${state.game.no}</div></div>
                </div>
                
                <div class="header-info-box" style="align-items:center;">
                    <div class="info-row" style="width:100%;">
                        <span class="info-label">日付:</span><div class="info-val">${state.game.date}</div>
                        <span class="info-label" style="margin-left:5px;">時間:</span><div class="info-val">${state.game.time}</div>
                    </div>
                    <div class="info-row" style="width:100%;"><span class="info-label">場所:</span><div class="info-val">${state.game.place}</div></div>
                </div>

                <div class="header-info-box">
                    <div class="info-row"><span class="info-label">チームB:</span><div class="info-val">${state.teamB.name}</div></div>
                    <div class="referee-box">
                        <div>
                            <div><span style="font-weight:bold;">クルーチーフ:</span> ${state.game.crewChief}</div>
                            <div><span style="font-weight:bold;">Umpire 1:</span> ${state.game.umpire1}</div>
                        </div>
                        <div style="text-align:right;">
                            <div><span style="font-weight:bold;">Umpire 2:</span> ${state.game.umpire2}</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="sheet-body">
                <div class="col-left">
                    ${renderTeam('teamA')}
                    ${renderTeam('teamB')}

                    <div class="score-summary">
                        <div class="summary-row summary-header">
                            <div class="s-wide s-cell">スコア</div>
                            <div class="s-cell">1Q</div>
                            <div class="s-cell">2Q</div>
                            <div class="s-cell">3Q</div>
                            <div class="s-cell">4Q</div>
                            <div class="s-cell">OT</div>
                        </div>
                        <div class="summary-row">
                            <div class="s-wide s-cell" style="font-weight:bold;">A</div>
                            <div class="s-cell">${calcQuarterScore('A', 1)}</div>
                            <div class="s-cell">${calcQuarterScore('A', 2)}</div>
                            <div class="s-cell">${calcQuarterScore('A', 3)}</div>
                            <div class="s-cell">${calcQuarterScore('A', 4)}</div>
                            <div class="s-cell">-</div>
                        </div>
                        <div class="summary-row">
                            <div class="s-wide s-cell" style="font-weight:bold;">B</div>
                            <div class="s-cell">${calcQuarterScore('B', 1)}</div>
                            <div class="s-cell">${calcQuarterScore('B', 2)}</div>
                            <div class="s-cell">${calcQuarterScore('B', 3)}</div>
                            <div class="s-cell">${calcQuarterScore('B', 4)}</div>
                            <div class="s-cell">-</div>
                        </div>
                        <div class="summary-row" style="background:#f0f0f0;">
                            <div class="s-cell" style="flex:4; justify-content:space-around; font-weight:bold;">
                                <span>最終スコア</span>
                                <span>A: ${calcScore('A')}</span>
                                <span>B: ${calcScore('B')}</span>
                            </div>
                        </div>
                        <div class="summary-row" style="height:24px;">
                            <div class="s-cell" style="flex:4; justify-content:flex-start; padding-left:5px;">
                                <span style="font-weight:bold; margin-right:5px;">勝者チーム:</span> 
                                ${calcScore('A') > calcScore('B') ? state.teamA.name : (calcScore('B') > calcScore('A') ? state.teamB.name : '')}
                            </div>
                        </div>
                        <div class="summary-row" style="border-bottom:none;">
                            <div class="s-cell" style="flex:4; justify-content:flex-end; padding-right:5px; font-size:8px;">
                                試合終了時間: ${state.game.endTime}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-right">
                    <div class="running-header">RUNNING SCORE</div>
                    <div class="running-body">
                        ${renderRunningColumn(0, 40)}
                        ${renderRunningColumn(40, 80)}
                        ${renderRunningColumn(80, 120)}
                        ${renderRunningColumn(120, 160)}
                    </div>
                </div>
            </div>

            <div class="sheet-footer">
                <div class="footer-item"><span style="font-weight:bold;">スコアラー:</span> <div style="border-bottom:1px solid black; flex:1; text-align:center;">${state.game.scorer}</div></div>
                <div class="footer-item"><span style="font-weight:bold;">A.スコアラー:</span> <div style="border-bottom:1px solid black; flex:1; text-align:center;">${state.game.assistantScorer}</div></div>
                <div class="footer-item"><span style="font-weight:bold;">タイマー:</span> <div style="border-bottom:1px solid black; flex:1; text-align:center;">${state.game.timer}</div></div>
                <div class="footer-item"><span style="font-weight:bold;">ショットクロック:</span> <div style="border-bottom:1px solid black; flex:1; text-align:center;">${state.game.shotClock}</div></div>
                <div style="width:100%; text-align:right; font-size:8px; margin-top:5px;">
                    JBA Official Score Sheet Layout (Compatible)
                </div>
            </div>
        </div>
    </div>
    `;
};

// --- App Mount ---

function render() {
    const app = document.getElementById('app');
    let content = '';
    
    if(state.view === 'input') content = InputView();
    else if(state.view === 'sheet') content = SheetView();
    else if(state.view === 'settings') content = SettingsView();
    
    app.innerHTML = Navbar() + content;
}

// 初期ロード
loadState();
render();

</script>
</body>
</html>

